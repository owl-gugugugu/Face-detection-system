# RK3568 开发板配置指南

本指南帮助你配置RK3568开发板的关键功能，用于智能门禁系统部署。

---

## 第一部分：配置 AP 热点模式

### 功能说明
将RK3568配置为WiFi热点，方便手机/电脑直接连接访问Web界面，无需路由器。

### 安装依赖
```bash
sudo apt-get update
sudo apt-get install hostapd dnsmasq
```

### 配置 hostapd（WiFi热点）

编辑配置文件：
```bash
sudo nano /etc/hostapd/hostapd.conf
```

添加以下内容：
```ini
interface=wlan0
driver=nl80211
ssid=SmartGate-AP
hw_mode=g
channel=7
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=12345678
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
```

**参数说明**：
- `ssid`: 热点名称（可修改）
- `wpa_passphrase`: WiFi密码（至少8位，可修改）
- `channel`: WiFi信道（建议7或11）

### 配置 dnsmasq（DHCP服务）

编辑配置：
```bash
sudo nano /etc/dnsmasq.conf
```

添加：
```ini
interface=wlan0
dhcp-range=192.168.50.10,192.168.50.100,255.255.255.0,24h
```

### 配置静态IP

编辑网络接口：
```bash
sudo nano /etc/network/interfaces
```

添加：
```
auto wlan0
iface wlan0 inet static
    address 192.168.50.1
    netmask 255.255.255.0
```

### 启动热点

```bash
# 停止网络管理器（避免冲突）
sudo systemctl stop NetworkManager

# 启动热点和DHCP
sudo systemctl start hostapd
sudo systemctl start dnsmasq

# 设置开机自启
sudo systemctl enable hostapd
sudo systemctl enable dnsmasq
```

### 测试连接

用手机搜索WiFi：
- 热点名称：`SmartGate-AP`
- 密码：`12345678`

连接后访问：`http://192.168.50.1:8000`

### 故障排查

**热点不出现**：
```bash
# 检查无线网卡
iwconfig

# 查看hostapd日志
sudo journalctl -u hostapd -f
```

**无法获取IP**：
```bash
# 重启dnsmasq
sudo systemctl restart dnsmasq

# 检查服务状态
sudo systemctl status dnsmasq
```

---

## 第二部分：LED 控制配置与测试

### 功能说明
使用板载LED指示系统状态（开门、识别失败等）。

### LED控制原理

RK3568通过sysfs接口控制LED：
```bash
# LED路径
ls /sys/class/leds/
```

常见LED：
- `sys_led` - 系统LED（推荐使用）
- `user` - 用户LED
- `work` - 工作LED

### 使用测试脚本

项目提供了`backend/scripts/check_led.sh`脚本。

**上传脚本到开发板**：
```bash
# 本地电脑执行
scp backend/scripts/check_led.sh root@<开发板IP>:/tmp/
```

**运行脚本**：

```bash
ssh root@<开发板IP>
cd /tmp
chmod +x check_led.sh
./check_led.sh
```

**脚本功能**：
1. 列出所有可用LED
2. 显示每个LED的状态（亮度、触发模式）
3. 推荐使用的LED
4. 交互式测试（开/关/闪烁）

**示例输出**：
```
[2] LED 详细信息：
--- sys_led ---
  当前亮度: 1
  最大亮度: 255
  触发模式: [none] timer heartbeat ...
  路径: /sys/class/leds/sys_led/

[3] 推荐配置：
✓ 推荐使用: sys_led
  配置路径: /sys/class/leds/sys_led/brightness
```

### 手动控制LED

**打开LED**：
```bash
echo 1 > /sys/class/leds/sys_led/brightness
```

**关闭LED**：
```bash
echo 0 > /sys/class/leds/sys_led/brightness
```

**闪烁模式**（心跳）：
```bash
echo heartbeat > /sys/class/leds/sys_led/trigger
```

**恢复手动控制**：
```bash
echo none > /sys/class/leds/sys_led/trigger
```

### 在代码中使用

修改`backend/config.py`：
```python
# LED配置
LED_PATH = "/sys/class/leds/sys_led/brightness"
```

`backend/core/doorController.py`中控制LED：
```python
def set_led(state):
    """控制LED状态"""
    try:
        with open(LED_PATH, 'w') as f:
            f.write('1' if state else '0')
    except Exception as e:
        print(f"LED控制失败: {e}")

# 开门时闪烁3次
for _ in range(3):
    set_led(True)
    time.sleep(0.2)
    set_led(False)
    time.sleep(0.2)
```

### 测试建议

运行`check_led.sh`并选择测试，观察LED是否正常工作。如果测试通过，记下LED名称（如`sys_led`），更新代码配置。

---

## 第三部分：OV5695 摄像头连接与测试

### 硬件连接

**物理连接**：
1. 关闭开发板电源
2. 将OV5695排线连接到RK3568的MIPI-CSI接口
3. 确保排线金属触点朝向正确（参考开发板说明书）
4. 固定排线卡扣
5. 开机

**检查驱动**：
```bash
# 查看设备节点
ls -l /dev/video*

# 应该看到：
# /dev/video0
# /dev/video1
# /dev/video11 等
```

```bash
# 检查驱动加载
dmesg | grep ov5695

# 应该看到类似：
# ov5695 0-0036: driver version: 00.01.01
# ov5695 0-0036: Detected OV5695 sensor
```

### 使用测试脚本

项目提供了`backend/scripts/test_camera.py`。

**上传并运行**：
```bash
# 上传脚本
scp -r backend/scripts root@<开发板IP>:/tmp/

# SSH登录
ssh root@<开发板IP>
cd /tmp/scripts

# 基础测试（自动检测摄像头）
python3 test_camera.py

# 完整测试（包括GStreamer和性能测试）
python3 test_camera.py --width 640 --height 480 --index 9 --skip-gstreamer --output ~/camera_test
```

**脚本功能**：

1. 检测所有video设备
2. 测试OpenCV模式（V4L2）
3. 测试GStreamer硬件加速模式
4. 性能测试（连续5秒，测量FPS）
5. 保存测试图片到`camera_test_output/`

**预期输出**：
```
[✓ PASS] Video 设备检测
      找到 3 个设备
[✓ PASS] OpenCV 打开摄像头
实际分辨率: 640x480
帧率: 30.0 FPS
[✓ PASS] 图像质量检查
      亮度正常
[✓ PASS] 保存图像
      文件: opencv_test_20251224_143025_640x480.jpg
```

### GStreamer硬件加速测试

如果OpenCV模式成功但GStreamer失败：

**安装依赖**：
```bash
sudo apt-get install gstreamer1.0-tools
sudo apt-get install gstreamer1.0-plugins-base
sudo apt-get install gstreamer1.0-rockchip  # RK3568专用
```

**验证插件**：

```bash
gst-inspect-1.0 rkisp  # 应该有输出
```

**手动测试管道**：
```bash
gst-launch-1.0 rkisp device=/dev/video0 io-mode=1 ! \
  video/x-raw,format=NV12,width=640,height=480,framerate=30/1 ! \
  videoconvert ! jpegenc ! filesink location=test.jpg
```

如果成功生成`test.jpg`且图片清晰，说明GStreamer正常。

### 配置系统使用摄像头

根据测试结果修改`backend/config.py`：

**如果GStreamer测试成功**（推荐）：

```python
CAMERA_MODE = 'gstreamer'  # 或 'auto'
CAMERA_INDEX = 0
CAMERA_WIDTH = 640
CAMERA_HEIGHT = 480
```

**如果只有OpenCV成功**：
```python
CAMERA_MODE = 'opencv'
CAMERA_INDEX = 1  # 根据测试结果调整
CAMERA_WIDTH = 640
CAMERA_HEIGHT = 480
```

### 查看测试图片

使用WinSCP或scp下载测试图片：
```bash
scp -r root@<开发板IP>:/tmp/scripts/camera_test_output ./
```

检查图片质量，确保清晰、色彩正常（无偏绿）。

### 故障排查

**无video设备**：
- 检查排线连接
- 重新加载驱动：`sudo modprobe ov5695`

**画面偏绿**：

- 尝试GStreamer模式（使用ISP）
- 或尝试不同的video索引

**性能差/卡顿**：
- 降低分辨率到640x480
- 使用GStreamer模式

---

## 总结

完成以上三步配置后：
1. 手机连接`SmartGate-AP`热点
2. 访问`http://192.168.50.1:8000`
3. LED指示系统状态
4. 摄像头实时识别人脸

配置文件位置：
- 热点：`/etc/hostapd/hostapd.conf`
- LED：`backend/config.py` 中的 `LED_PATH`
- 摄像头：`backend/config.py` 中的 `CAMERA_MODE`
