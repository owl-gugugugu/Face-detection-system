# OV5695 æ‘„åƒå¤´æ¥å…¥ä¸æ•°æ®æµå¤„ç†æ–‡æ¡£

## Task

- ç¼–å†™æ‘„åƒå¤´æ§åˆ¶è„šæœ¬ï¼Œå®ç°å¯¹ ov5695 æ•è·åˆ°çš„å›¾ç‰‡è¿›è¡Œåºåˆ—åŒ–å‘½åã€‚
   - å‘½åæ ¼å¼ï¼šå¹´-æœˆ-æ—¥-æ—¶-åˆ†-ç§’-å¸§
   - ä¾‹å¦‚ï¼š2025_12_19_11_17_37_01.jpg, 2025_12_19_11_17_37_30.jpgã€‚ï¼ˆä¸€ç§’é’Ÿæœ€å¤š30å¸§ï¼‰
- ç¼–å†™æ–‡æ¡£è§£é‡Š ov5695 çš„å·¥ä½œæœºåˆ¶ï¼š
   - æ€ä¹ˆæ•è·å›¾ç‰‡
   - å›¾ç‰‡æ€ä¹ˆå­˜å‚¨å’Œå‘½å
   - æ€ä¹ˆä½¿ç”¨ opencv ä¼ åˆ°åç«¯è¿›è¡Œå¤„ç†çš„
   - å¦‚ä½•å®ç°è·¨å¹³å°å…¼å®¹ä¸æ•…éšœé™çº§

## 1. ç¡¬ä»¶æ¦‚è¿°

- è®¾å¤‡å‹å·ï¼šOV5695 (500ä¸‡åƒç´ )
- æ¥å£ç±»å‹ï¼šMIPI-CSI (Mobile Industry Processor Interface)
- è¿æ¥å¹³å°ï¼šRK3568 å¼€å‘æ¿
- é©±åŠ¨èŠ‚ç‚¹ï¼šé€šå¸¸æ˜ å°„ä¸º `/dev/video0` (éœ€é…åˆ ISP ä½¿ç”¨)

## 2. æ¥å…¥ç­–ç•¥å˜é©

æ ¹æ®ç³»ç»Ÿå¯¹å®æ—¶æ€§ï¼ˆè§†é¢‘æµé¢„è§ˆï¼‰ã€å¯¿å‘½ï¼ˆeMMCè¯»å†™æŸè€—ï¼‰åŠå¯ç§»æ¤æ€§çš„è¦æ±‚ï¼Œæˆ‘ä»¬å¯¹æ•°æ®å¤„ç†é€»è¾‘è¿›è¡Œäº†å¦‚ä¸‹è°ƒæ•´ï¼š

| åŠŸèƒ½æ¨¡å— | åŸå§‹è®¾æƒ³ (æ–‡ä»¶IO) | **å½“å‰å®ç° (å†…å­˜æµ)** | ä¼˜åŠ¿ |
| :--- | :--- | :--- | :--- |
| **äººè„¸å½•å…¥** | å­˜æˆ JPG æ–‡ä»¶ -> å‰ç«¯è¯»å–æ˜¾ç¤º | **MJPEG è§†é¢‘æµ** (RAM -> HTTP) | é›¶å»¶è¿Ÿï¼Œå‰ç«¯å®æ—¶é¢„è§ˆï¼Œä¸å å­˜å‚¨ |
| **ç§»åŠ¨ä¾¦æµ‹** | å­˜ N å¼ å›¾ -> è¯»å‡º N-9 å¸§æ¯”å¯¹ | **ç¯å½¢ç¼“å†²é˜Ÿåˆ—** (RAM Deque) | æé€Ÿæ¯”å¯¹ï¼Œä¿æŠ¤ Flash å¯¿å‘½ |
| **æœ€ç»ˆå­˜å‚¨** | å­˜å‚¨æ‰€æœ‰æ•è·å›¾ç‰‡ | **ä»…å­˜å‚¨ç‰¹å¾å‘é‡** (å’Œå¿…è¦çš„åº•åº“å›¾) | èŠ‚çœç©ºé—´ï¼Œæ•°æ®ç»“æ„åŒ– |
| **é©±åŠ¨æ¨¡å¼** | ä»… GStreamer | **åŒæ¨¡é€‚é… (GStreamer + V4L2)** | ä¼˜å…ˆç¡¬ä»¶åŠ é€Ÿï¼Œå¤±è´¥è‡ªåŠ¨é™çº§ï¼Œå…¼å®¹ PC è°ƒè¯• |

---

## 3. ç¡¬ä»¶éªŒè¯è„šæœ¬ (capture_tool.py)

è¯¥è„šæœ¬å·²å‡çº§ä¸º**åŒæ¨¡è‡ªé€‚åº”**ç‰ˆæœ¬ã€‚å®ƒä¼šä¼˜å…ˆå°è¯• RK3568 çš„ç¡¬ä»¶åŠ é€Ÿç®¡é“ï¼›å¦‚æœå¤±è´¥ï¼ˆæˆ–åœ¨é RK å¹³å°è¿è¡Œï¼‰ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ ‡å‡† OpenCV å…¼å®¹æ¨¡å¼

> **ä»£ç ä»…ä¾›å‚è€ƒ**

**è„šæœ¬åŠŸèƒ½**ï¼šæ•è·å›¾ç‰‡å¹¶æŒ‰ `å¹´-æœˆ-æ—¥-æ—¶-åˆ†-ç§’-å¸§` æ ¼å¼å‘½åå­˜å‚¨ã€‚

```python
import cv2
import os
import time
from datetime import datetime

# ================= é…ç½® =================
# æµ‹è¯•å›¾ç‰‡ä¿å­˜è·¯å¾„
SAVE_DIR = os.path.expanduser("~/camera_capture/")

# æ–¹æ¡ˆ A: RK3568 GStreamer ç®¡é“ (ç¡¬ä»¶åŠ é€Ÿ, æ€§èƒ½ä¼˜å…ˆ)
GST_PIPELINE = (
    "rkisp device=/dev/video0 io-mode=1 ! "
    "video/x-raw,format=NV12,width=1920,height=1080,framerate=30/1 ! "
    "videoconvert ! "
    "video/x-raw,format=BGR ! appsink"
)
# =======================================

def ensure_dir(directory):
    if not os.path.exists(directory):
        os.makedirs(directory)

def init_camera():
    """
    åŒæ¨¡åˆå§‹åŒ–é€»è¾‘ï¼š
    1. ä¼˜å…ˆå°è¯• GStreamer (RK3568 ä¸“ç”¨)
    2. å¤±è´¥åˆ™å›é€€åˆ° V4L2 (é€šç”¨æ ‡å‡†)
    """
    cap = None
    
    # --- å°è¯•æ–¹æ¡ˆ A: GStreamer ---
    print("[Info] å°è¯•åˆå§‹åŒ– GStreamer ç¡¬ä»¶åŠ é€Ÿç®¡é“...")
    try:
        cap = cv2.VideoCapture(GST_PIPELINE, cv2.CAP_GSTREAMER)
        if cap.isOpened():
            print("[Success] GStreamer æ¨¡å¼å¯åŠ¨æˆåŠŸï¼")
            return cap
    except Exception as e:
        print(f"[Warning] GStreamer å¯åŠ¨å¼‚å¸¸: {e}")

    # --- å°è¯•æ–¹æ¡ˆ B: é€šç”¨ V4L2 (é™çº§æ–¹æ¡ˆ) ---
    print("[Info] GStreamer å¤±è´¥ï¼Œåˆ‡æ¢è‡³é€šç”¨ V4L2 æ¨¡å¼...")
    # éå†ç´¢å¼•ï¼Œé˜²æ­¢ video0 è¢«å ç”¨æˆ–ä¸º Raw è®¾å¤‡
    for index in [0, 1, 11, 21]: 
        print(f"  - å°è¯•è®¾å¤‡ç´¢å¼•: /dev/video{index} ...")
        cap = cv2.VideoCapture(index)
        if cap.isOpened():
            # è¯»å–ä¸€å¸§éªŒè¯
            ret, _ = cap.read()
            if ret:
                print(f"[Success] é€šç”¨æ¨¡å¼å¯åŠ¨æˆåŠŸ (Index: {index})")
                # é™åˆ¶åˆ†è¾¨ç‡ä»¥ä¿æŠ¤ CPU
                cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
                cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
                return cap
            else:
                cap.release()
    
    return None

def main():
    cap = init_camera()
    
    if cap is None:
        print("[Error] æ— æ³•æ‰“å¼€ä»»ä½•æ‘„åƒå¤´ï¼è¯·æ£€æŸ¥æ’çº¿è¿æ¥ã€‚")
        return

    ensure_dir(SAVE_DIR)
    print(f"[Info] æ­£åœ¨æ•è·... å›¾ç‰‡å°†ä¿å­˜è‡³ {SAVE_DIR}")
    print("æŒ‰ 'q' åœæ­¢")

    last_second_str = ""
    frame_counter = 0

    try:
        while True:
            ret, frame = cap.read()
            if not ret:
                print("[Error] ä¸¢å¸§æˆ–è®¾å¤‡æ–­å¼€")
                break

            # --- åºåˆ—åŒ–å‘½åé€»è¾‘ ---
            now = datetime.now()
            current_second_str = now.strftime("%Y_%m_%d_%H_%M_%S")

            if current_second_str != last_second_str:
                last_second_str = current_second_str
                frame_counter = 1
            else:
                frame_counter += 1

            if frame_counter <= 30:
                filename = f"{current_second_str}_{frame_counter:02d}.jpg"
                filepath = os.path.join(SAVE_DIR, filename)
                
                # å†™å…¥ç¡¬ç›˜
                cv2.imwrite(filepath, frame)
                print(f"\r[Saved] {filename}", end="")

            if cv2.waitKey(1) & 0xFF == ord('q'):
                break

    except KeyboardInterrupt:
        pass
    finally:
        if cap: cap.release()
        print("\n[Info] æµ‹è¯•ç»“æŸ")

if __name__ == "__main__":
    main()
```

---

## 4. ç”Ÿäº§ç¯å¢ƒå·¥ä½œæœºåˆ¶è¯¦è§£

åœ¨æ­£å¼çš„åç«¯ç¨‹åº (`backend/`) ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†æ›´å¤æ‚çš„ç­–ç•¥æ¥ç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚

### 4.1 æ ¸å¿ƒæœºåˆ¶ï¼šåŒæ¨¡é€‚é…å™¨ (Adapter Pattern)

ä¸ºäº†é¿å…ä»£ç æ­»ç»‘åœ¨ RK3568 å¹³å°ä¸Šï¼Œ`GlobalCamera` ç±»å®ç°äº†è‡ªåŠ¨æ£€æµ‹é€»è¾‘ï¼š

1.  **ä¼˜å…ˆæ¨¡å¼ (GStreamer)**ï¼š
    *   é€‚ç”¨åœºæ™¯ï¼šRK3568 å¼€å‘æ¿ç”Ÿäº§ç¯å¢ƒã€‚
    *   åŸç†ï¼š`Sensor -> ISP -> NV12 -> GStreamer -> OpenCV`ã€‚
    *   ä¼˜ç‚¹ï¼šCPU å ç”¨ç‡æä½ (<5%)ï¼Œæ”¯æŒé«˜åˆ†è¾¨ç‡ (1080P/30fps)ï¼Œå›¾åƒç»è¿‡ ISP è°ƒä¼˜ï¼Œè‰²å½©æ­£å¸¸ã€‚

2.  **å¤‡ç”¨æ¨¡å¼ (Standard V4L2)**ï¼š
    *   é€‚ç”¨åœºæ™¯ï¼šGStreamer åˆå§‹åŒ–å¤±è´¥ã€PC ç«¯å¼€å‘è°ƒè¯•ã€ç§»æ¤åˆ°æ ‘è“æ´¾ç­‰å…¶ä»–æ¿å¡ã€‚
    *   åŸç†ï¼š`Sensor -> CPU Soft Decode -> OpenCV`ã€‚
    *   ä»£ä»·ï¼šCPU å ç”¨ç‡è¾ƒé«˜ï¼Œå»ºè®®å¼ºåˆ¶å°†åˆ†è¾¨ç‡é™çº§ä¸º **640x480** ä»¥ä¿è¯æµç•…åº¦ã€‚è‹¥åœ¨ RK3568 ä¸Šç›´æ¥ä½¿ç”¨æ­¤æ¨¡å¼è¯»å– Raw Sensorï¼Œå›¾åƒå¯èƒ½ä¼šåç»¿ï¼ˆç¼ºå°‘ ISP å¤„ç†ï¼‰ï¼Œä½†ä¸å½±å“äººè„¸æ£€æµ‹ï¼ˆæ£€æµ‹ä¸»è¦ä¾èµ–ç°åº¦ç‰¹å¾ï¼‰ã€‚

### 4.2 å›¾ç‰‡æ€ä¹ˆå­˜å‚¨ï¼ˆå†…å­˜åŒ–ï¼‰

åœ¨ç”Ÿäº§é€»è¾‘ä¸­ï¼Œä¸è¿›è¡Œæ–‡ä»¶å­˜å‚¨ï¼Œè€Œæ˜¯ä½¿ç”¨**å†…å­˜ç¼“å­˜**ï¼š

*   **è§†é¢‘æµé¢„è§ˆ (MJPEG)**ï¼š
    *   OpenCV è¯»å–ä¸€å¸§ (`numpy array`)
    *   åœ¨å†…å­˜ä¸­ç¼–ç ä¸º JPG æ ¼å¼ (`cv2.imencode`)
    *   é€šè¿‡ HTTP åè®®ç›´æ¥å‘é€ç»™å‰ç«¯æµè§ˆå™¨
    *   **ç»“æœ**ï¼šæ•°æ®æµè¿‡å³ç„šï¼Œä¸å ç”¨ç£ç›˜

*   **ç§»åŠ¨ä¾¦æµ‹ (å¸§å·®æ³•)**ï¼š
    *   ä½¿ç”¨ `collections.deque(maxlen=10)` åˆ›å»ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„å†…å­˜é˜Ÿåˆ—
    *   æ–°å¸§å…¥é˜Ÿï¼Œæ—§å¸§è‡ªåŠ¨å‡ºé˜Ÿ
    *   ç›´æ¥åœ¨å†…å­˜ä¸­å– `Buffer[0]` (å†å²å¸§) å’Œ `Buffer[-1]` (å½“å‰å¸§) è¿›è¡Œ `cv2.absdiff` è®¡ç®—

### 4.3 æ€ä¹ˆä¼ åˆ°åç«¯å¤„ç† (GlobalCamera)

ä¸ºäº†é˜²æ­¢å¤šä¸ªçº¿ç¨‹ï¼ˆAPI çº¿ç¨‹ã€åå°ç›‘æ§çº¿ç¨‹ï¼‰äº‰æŠ¢æ‘„åƒå¤´å¯¼è‡´å´©æºƒï¼Œæˆ‘ä»¬é‡‡ç”¨äº† **å•ä¾‹æ¨¡å¼ (Singleton) + çº¿ç¨‹é” (Lock)**ã€‚

**æ¶æ„è®¾è®¡**ï¼š
1.  `GlobalCamera` ç±»ï¼šç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œ **init_camera()** åŒæ¨¡åˆå§‹åŒ–é€»è¾‘ï¼Œç‹¬å  `/dev/video*`
2.  æ–¹æ³•å°è£…ï¼š
    *   `get_frame()`: è¿”å›åŸå§‹ NumPy æ•°ç»„ï¼ˆä¾› AI å¼•æ“æå–ç‰¹å¾ï¼‰
    *   `get_jpg()`: è¿”å›äºŒè¿›åˆ¶ JPG æ•°æ®ï¼ˆä¾› Web å‰ç«¯ç›´æ’­ï¼‰
3.  è°ƒç”¨é€»è¾‘ï¼š
    *   FastAPI è°ƒç”¨ `get_jpg()` -> æ¨æµç»™ç”¨æˆ·æ‰‹æœº
    *   åå°çº¿ç¨‹ è°ƒç”¨ `get_frame()` -> å­˜å…¥é˜Ÿåˆ— -> ç§»åŠ¨ä¾¦æµ‹ -> è§¦å‘ AI

---

## 5. æ€»ç»“

é€šè¿‡ä¸Šè¿°è®¾è®¡ï¼Œæˆ‘ä»¬å®ç°äº† OV5695 çš„é«˜æ•ˆä¸”ç¨³å¥çš„åˆ©ç”¨ï¼š
1.  **ä½å»¶è¿Ÿ**ï¼šåˆ©ç”¨ç¡¬ä»¶ ISP å’Œå†…å­˜æ“ä½œï¼Œå®ç°æµç•…çš„ Web é¢„è§ˆ
2.  **é«˜å¯¿å‘½**ï¼šå®Œå…¨ç§»é™¤äº†éå¿…è¦çš„ç£ç›˜å†™å…¥æ“ä½œï¼Œä¿æŠ¤å¼€å‘æ¿ Flash
3.  **é«˜å¯ç”¨ (Robustness)**ï¼šå¼•å…¥ **GStreamer/V4L2 è‡ªåŠ¨åˆ‡æ¢æœºåˆ¶**ï¼Œå³ä½¿ç¡¬ä»¶åŠ é€Ÿå¤±æ•ˆæˆ–æ›´æ¢ç¡¬ä»¶å¹³å°ï¼Œç³»ç»Ÿä»èƒ½å¯åŠ¨å¹¶æä¾›åŸºç¡€æœåŠ¡ï¼ˆé™çº§è¿è¡Œï¼‰ï¼Œé¿å…äº†ä¸€æŒ‚å…¨æŒ‚çš„é£é™©

---

## 6. åŒæ¨¡é…ç½®åˆ‡æ¢æŒ‡å—ï¼ˆç”Ÿäº§å®æˆ˜ï¼‰

### 6.1 åŒæ¨¡æ¶æ„å®ç°è¯´æ˜

ç³»ç»Ÿå·²åœ¨ `backend/core/camera.py` å’Œ `backend/config.py` ä¸­å®ç°å®Œæ•´çš„åŒæ¨¡åˆ†ç¦»æ¶æ„ï¼š

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½ |
|------|------|---------|------|
| **gstreamer** | GStreamer ç¡¬ä»¶åŠ é€Ÿç®¡é“ | RK3568 ç”Ÿäº§ç¯å¢ƒ | ğŸŸ¢ ä¼˜ç§€ (CPU<5%) |
| **opencv** | æ ‡å‡† OpenCV V4L2 | PCå¼€å‘ã€æ•…éšœé™çº§ | ğŸŸ¡ ä¸€èˆ¬ (CPUè¾ƒé«˜) |

**æ ¸å¿ƒé…ç½®å‚æ•°**ï¼ˆä½äº `backend/config.py`ï¼‰ï¼š

```python
# æ‘„åƒå¤´åˆå§‹åŒ–æ¨¡å¼ - å…³é”®é…ç½®
CAMERA_MODE = 'auto'  # å¯é€‰: 'auto', 'gstreamer', 'opencv'

# GStreamer ç®¡é“é…ç½®ï¼ˆä»…åœ¨ gstreamer æ¨¡å¼ä½¿ç”¨ï¼‰
GSTREAMER_PIPELINE = (
    "rkisp device=/dev/video{index} io-mode=1 ! "
    "video/x-raw,format=NV12,width={width},height={height},framerate={fps}/1 ! "
    "videoconvert ! video/x-raw,format=BGR ! appsink"
)

# OpenCV æ¨¡å¼ä¸‹å°è¯•çš„è®¾å¤‡ç´¢å¼•åˆ—è¡¨
CAMERA_FALLBACK_INDICES = [0, 1, 11, 21]

# åˆ†è¾¨ç‡é…ç½®
CAMERA_INDEX = 0
CAMERA_WIDTH = 640
CAMERA_HEIGHT = 480
CAMERA_FPS = 30
```

---

### 6.2 ä¸‰ç§å·¥ä½œæ¨¡å¼è¯¦è§£

#### æ¨¡å¼ 1ï¼š`'auto'` - è‡ªåŠ¨é€‚é…ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰

```python
CAMERA_MODE = 'auto'
```

**å·¥ä½œæµç¨‹**ï¼š
```
å¯åŠ¨ Camera ç±»
    â†“
ä¼˜å…ˆå°è¯• _init_gstreamer()
    â”œâ”€ æ„å»º GStreamer ç®¡é“
    â”œâ”€ è°ƒç”¨ cv2.VideoCapture(pipeline, CAP_GSTREAMER)
    â”œâ”€ è¯»å–ä¸€å¸§éªŒè¯
    â†“
æˆåŠŸï¼Ÿ â†’ ä½¿ç”¨ gstreamer æ¨¡å¼ âœ…
    â†“ å¤±è´¥
è‡ªåŠ¨é™çº§åˆ° _init_opencv()
    â”œâ”€ éå†è®¾å¤‡ç´¢å¼• [0, 1, 11, 21]
    â”œâ”€ æ¯ä¸ªè®¾å¤‡å°è¯•æ‰“å¼€å¹¶è¯»å¸§
    â†“
æ‰¾åˆ°å¯ç”¨è®¾å¤‡ï¼Ÿ â†’ ä½¿ç”¨ opencv æ¨¡å¼ âœ…
    â†“ å¤±è´¥
æŠ›å‡ºå¼‚å¸¸ï¼šValueError("Failed to open camera in any mode")
```

**æ—¥å¿—ç¤ºä¾‹ï¼ˆGStreamer æˆåŠŸï¼‰**ï¼š

```
[Camera] è‡ªåŠ¨æ¨¡å¼ï¼šä¼˜å…ˆå°è¯• GStreamer
[Camera] Trying GStreamer pipeline:
[Camera]   rkisp device=/dev/video0 io-mode=1 ! video/x-raw,format=NV12...
[Camera] GStreamer mode initialized successfully
[Camera] Camera opened successfully
[Camera]   Mode:      gstreamer
[Camera]   Device:    /dev/video0
[Camera]   Requested: 640x480 @ 30fps
[Camera]   Actual:    640x480 @ 30fps
```

**æ—¥å¿—ç¤ºä¾‹ï¼ˆé™çº§åˆ° OpenCVï¼‰**ï¼š
```
[Camera] è‡ªåŠ¨æ¨¡å¼ï¼šä¼˜å…ˆå°è¯• GStreamer
[Camera] GStreamer pipeline failed to open
[Camera] GStreamer åˆå§‹åŒ–å¤±è´¥ï¼Œé™çº§åˆ° OpenCV æ¨¡å¼
[Camera] Trying OpenCV V4L2 mode with indices: [0, 1, 11, 21]
[Camera] Trying /dev/video0 ...
[Camera]   /dev/video0 cannot open
[Camera] Trying /dev/video1 ...
[Camera] OpenCV mode initialized successfully on /dev/video1
[Camera] Camera opened successfully
[Camera]   Mode:      opencv
[Camera]   Device:    /dev/video1
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… **RK3568 ç”Ÿäº§ç¯å¢ƒ**ï¼šè‡ªåŠ¨ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿï¼Œæ€§èƒ½æœ€ä½³
- âœ… **PC å¼€å‘ç¯å¢ƒ**ï¼šè‡ªåŠ¨é™çº§åˆ°å…¼å®¹æ¨¡å¼ï¼Œæ— éœ€ä¿®æ”¹é…ç½®
- âœ… **ä¸ç¡®å®šç¡¬ä»¶é…ç½®æ—¶**ï¼šè®©ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹æ¡ˆ

---

#### æ¨¡å¼ 2ï¼š`'gstreamer'` - å¼ºåˆ¶ GStreamerï¼ˆé«˜æ€§èƒ½ï¼‰

```python
CAMERA_MODE = 'gstreamer'
```

**ç‰¹ç‚¹**ï¼š
- åªè°ƒç”¨ `_init_gstreamer()`
- å¤±è´¥ç›´æ¥æŠ›å¼‚å¸¸ï¼Œä¸å°è¯• OpenCV
- å¼ºåˆ¶ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿï¼Œç¡®ä¿æ€§èƒ½

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… **ç¡®è®¤ RK3568 + GStreamer ç¯å¢ƒæ­£å¸¸**
- âœ… **éœ€è¦æœ€ä½³æ€§èƒ½**ï¼ˆCPU<5%ï¼Œæ”¯æŒ1080P@30fpsï¼‰
- âœ… **ç”Ÿäº§ç¯å¢ƒç¨³å®šå**ï¼Œé¿å…æ„å¤–é™çº§

**æ³¨æ„**ï¼š

- âš ï¸  å¤±è´¥ä¼šå¯¼è‡´ç³»ç»Ÿæ— æ³•å¯åŠ¨
- âš ï¸  ä»…é€‚ç”¨äº RK3568ï¼ŒPC ä¸Šä¼šæŠ¥é”™

---

#### æ¨¡å¼ 3ï¼š`'opencv'` - å¼ºåˆ¶ OpenCVï¼ˆå…¼å®¹æ€§ï¼‰

```python
CAMERA_MODE = 'opencv'
```

**ç‰¹ç‚¹**ï¼š
- åªè°ƒç”¨ `_init_opencv()`
- éå† `CAMERA_FALLBACK_INDICES = [0, 1, 11, 21]`
- æ‰¾åˆ°ç¬¬ä¸€ä¸ªèƒ½è¯»å–å¸§çš„è®¾å¤‡

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… **GStreamer æœ‰é—®é¢˜æ—¶**çš„åº”æ€¥é™çº§æ–¹æ¡ˆ
- âœ… **PC å¼€å‘è°ƒè¯•**ï¼ˆWindows/Mac/Linuxï¼‰
- âœ… **å¿«é€Ÿæ’æŸ¥æ‘„åƒå¤´è¿æ¥é—®é¢˜**

**æ³¨æ„**ï¼š
- âš ï¸  æ€§èƒ½è¾ƒå·®ï¼ˆCPU 30-50%ï¼‰
- âš ï¸  å»ºè®®é™ä½åˆ†è¾¨ç‡ï¼ˆ640x480ï¼‰

---

### 6.3 å¿«é€Ÿæ•…éšœåˆ‡æ¢æ“ä½œ

#### åœºæ™¯ï¼šRK3568 å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**ï¼š
```bash
ValueError: Failed to open camera in GStreamer mode
# æˆ–è€…
ç³»ç»Ÿå¯åŠ¨åæ— æ³•åˆå§‹åŒ–æ‘„åƒå¤´
```

**ç«‹å³åˆ‡æ¢æ–¹æ¡ˆ**ï¼š

**æ­¥éª¤ 1**ï¼šSSH ç™»å½• RK3568
```bash
ssh root@192.168.x.x
```

**æ­¥éª¤ 2**ï¼šç¼–è¾‘é…ç½®æ–‡ä»¶

```bash
cd /path/to/project
vim backend/config.py
```

**æ­¥éª¤ 3**ï¼šä¿®æ”¹æ¨¡å¼
```python
# æ‰¾åˆ°è¿™ä¸€è¡Œ
CAMERA_MODE = 'auto'  # æˆ– 'gstreamer'

# æ”¹ä¸º
CAMERA_MODE = 'opencv'
```

**æ­¥éª¤ 4**ï¼šä¿å­˜å¹¶é‡å¯æœåŠ¡
```bash
# ä¿å­˜é€€å‡º vim (:wq)
# é‡å¯æœåŠ¡
systemctl restart smart-door

# æˆ–è€…æ‰‹åŠ¨è¿è¡Œ
python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000
```

**æ­¥éª¤ 5**ï¼šæŸ¥çœ‹æ—¥å¿—ç¡®è®¤
```bash
journalctl -u smart-door -f | grep Camera

# æˆ–è€…
tail -f /var/log/smart-door.log | grep Camera
```

**é¢„æœŸæ—¥å¿—**ï¼š
```
[Camera] å¼ºåˆ¶ä½¿ç”¨ OpenCV æ¨¡å¼
[Camera] Trying OpenCV V4L2 mode with indices: [0, 1, 11, 21]
[Camera] OpenCV mode initialized successfully on /dev/video1
[Camera]   Mode:      opencv  â† ç¡®è®¤ä½¿ç”¨ OpenCV
```

**æ­¥éª¤ 6**ï¼šï¼ˆå¯é€‰ï¼‰å›ºå®šè®¾å¤‡ç´¢å¼•

å¦‚æœå‘ç° video1 å¯ç”¨ï¼Œé¿å…æ¯æ¬¡éƒ½å°è¯• video0ï¼š
```python
# backend/config.py
CAMERA_INDEX = 1  # å›ºå®šä¸º 1
CAMERA_FALLBACK_INDICES = [1]  # åªå°è¯• video1
```

---

### 6.4 é…ç½®æœ€ä½³å®è·µ

#### æ¨èï¼šç”Ÿäº§ç¯å¢ƒé…ç½®

```python
# backend/config.py

# æ¨¡å¼ï¼šè‡ªåŠ¨é€‚é…ï¼ˆæ¨èï¼‰
CAMERA_MODE = 'auto'

# è®¾å¤‡ç´¢å¼•
CAMERA_INDEX = 0

# åˆ†è¾¨ç‡ï¼šVGAï¼ˆæ€§èƒ½ä¸ç”»è´¨å¹³è¡¡ï¼‰
CAMERA_WIDTH = 640
CAMERA_HEIGHT = 480
CAMERA_FPS = 30

# é™çº§ç´¢å¼•åˆ—è¡¨
CAMERA_FALLBACK_INDICES = [0, 1, 11, 21]
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¼˜å…ˆç¡¬ä»¶åŠ é€Ÿï¼Œæ€§èƒ½æœ€ä½³
- âœ… å¤±è´¥è‡ªåŠ¨é™çº§ï¼Œç³»ç»Ÿå¯ç”¨
- âœ… åˆ†è¾¨ç‡é€‚ä¸­ï¼Œé—¨ç¦åœºæ™¯è¶³å¤Ÿ

---

#### å¼€å‘ï¼šPC è°ƒè¯•é…ç½®

```python
# backend/config.py

# æ¨¡å¼ï¼šå¼ºåˆ¶ OpenCVï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰
CAMERA_MODE = 'opencv'

# è®¾å¤‡ç´¢å¼•ï¼š0ï¼ˆPC é»˜è®¤æ‘„åƒå¤´ï¼‰
CAMERA_INDEX = 0

# åˆ†è¾¨ç‡ï¼šVGA
CAMERA_WIDTH = 640
CAMERA_HEIGHT = 480
CAMERA_FPS = 30
```

---

#### ä¼˜åŒ–ï¼šé«˜æ€§èƒ½é…ç½®ï¼ˆç¨³å®šåï¼‰

```python
# backend/config.py

# æ¨¡å¼ï¼šå¼ºåˆ¶ GStreamerï¼ˆæœ€ä½³æ€§èƒ½ï¼‰
CAMERA_MODE = 'gstreamer'

# è®¾å¤‡ç´¢å¼•ï¼š0ï¼ˆISP å…¥å£ï¼‰
CAMERA_INDEX = 0

# åˆ†è¾¨ç‡ï¼šHDï¼ˆå……åˆ†åˆ©ç”¨ç¡¬ä»¶åŠ é€Ÿï¼‰
CAMERA_WIDTH = 1280
CAMERA_HEIGHT = 720
CAMERA_FPS = 30
```

**å‰æ**ï¼šç¡®è®¤ GStreamer ç¨³å®šè¿è¡Œ

---

### 6.5 å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜ 1ï¼šå¯åŠ¨å¤±è´¥ï¼Œæ— æ³•æ‰“å¼€æ‘„åƒå¤´

**é”™è¯¯æ—¥å¿—**ï¼š
```
ValueError: Failed to open camera in any mode
```

**æ’æŸ¥æ­¥éª¤**ï¼š

**1. æ£€æŸ¥è®¾å¤‡èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨**
```bash
ls -l /dev/video*

# åº”è¯¥çœ‹åˆ°ï¼š
# crw-rw----+ 1 root video 81, 0 Dec 19 10:30 /dev/video0
# crw-rw----+ 1 root video 81, 1 Dec 19 10:30 /dev/video1
```

å¦‚æœæ²¡æœ‰ä»»ä½• video è®¾å¤‡ â†’ é©±åŠ¨æœªåŠ è½½

**2. æ£€æŸ¥é©±åŠ¨æ˜¯å¦åŠ è½½**
```bash
dmesg | grep ov5695

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# [    2.123456] ov5695 0-0036: driver version: 00.01.01
# [    2.234567] ov5695 0-0036: Detected OV5695 sensor
```

å¦‚æœæ²¡æœ‰ç›¸å…³æ—¥å¿— â†’ æ£€æŸ¥æ‘„åƒå¤´æ’çº¿è¿æ¥

**3. æ£€æŸ¥è®¾å¤‡ä¿¡æ¯**
```bash
v4l2-ctl --list-devices

# åº”è¯¥çœ‹åˆ°ï¼š
# rkisp-statistics (platform:rkisp):
#         /dev/video0
#         /dev/video1
#
# ov5695 0-0036 (i2c):
#         /dev/video21
```

**4. æ‰‹åŠ¨æµ‹è¯•å„ä¸ªè®¾å¤‡**
```bash
for i in 0 1 11 21; do
  echo "Testing /dev/video$i"
  v4l2-ctl -d /dev/video$i --list-formats-ext 2>&1 | head -10
done
```

æ‰¾åˆ°å¯ç”¨è®¾å¤‡åæ›´æ–°é…ç½®ã€‚

---

#### â—ï¸é—®é¢˜ 2ï¼šGStreamer ç®¡é“æ— æ³•æ‰“å¼€

**é”™è¯¯æ—¥å¿—**ï¼š
```
[Camera] GStreamer pipeline failed to open
```

**å¯èƒ½åŸå› **ï¼š
1. OpenCV æœªç¼–è¯‘ GStreamer æ”¯æŒ
2. GStreamer æ’ä»¶ç¼ºå¤±
3. ç®¡é“è¯­æ³•é”™è¯¯
4. è®¾å¤‡ç´¢å¼•ä¸å¯¹

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ A**ï¼šéªŒè¯ OpenCV GStreamer æ”¯æŒ
```python
import cv2
print(cv2.getBuildInformation())
# æŸ¥æ‰¾ï¼šGStreamer: YES
```

å¦‚æœæ˜¾ç¤º `GStreamer: NO` â†’ éœ€è¦é‡æ–°ç¼–è¯‘ OpenCV

â—ï¸**æ–¹æ¡ˆ B**ï¼šéªŒè¯ GStreamer æ’ä»¶

åœ¨ RK3568 å¼€å‘æ¿çš„ç»ˆç«¯ï¼ˆMobaXtermï¼‰ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œ**æŸ¥çœ‹ç³»ç»Ÿæ˜¯å¦å·²ç»å®‰è£…äº† GStreamer åŸºç¡€å·¥å…·**

```bash
gst-inspect-1.0 --version
```

- å¦‚æœæ˜¾ç¤ºç‰ˆæœ¬å·ï¼ˆå¦‚ 1.16.x æˆ– 1.18.xï¼‰ï¼šè¯´æ˜åŸºç¡€ç¯å¢ƒæ˜¯æœ‰çš„
- å¦‚æœæç¤º command not foundï¼šè¯´æ˜éœ€è¦å®‰è£…å·¥å…·åŒ…

```bash
sudo apt-get install gstreamer1.0-tools gstreamer1.0-plugins-base
sudo apt-get install gstreamer1.0-plugins-good gstreamer1.0-plugins-bad
sudo apt-get install gstreamer1.0-plugins-ugly gstreamer1.0-libav
sudo apt-get install python3-gst-1.0 libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
```

**æ£€æŸ¥ Rockchip æ’ä»¶æ˜¯å¦å®‰è£…**ï¼š

RK3568 ä¹‹æ‰€ä»¥å¼ºï¼Œæ˜¯å› ä¸ºå®ƒæœ‰ rkisp (å¤„ç†æ‘„åƒå¤´) å’Œ mpp (å¤„ç†ç¼–è§£ç ) æ’ä»¶ã€‚

```bash
gst-inspect-1.0 | grep rk
gst-inspect-1.0 rkisp
gst-inspect-1.0 videoconvert
```

ä½ å¸Œæœ›èƒ½çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼ˆåŒ…å« rkisp æ˜¯æœ€é‡è¦çš„ï¼‰ï¼š

- rockchip: rkisp: Rockchip ISP <-- **æ ¸å¿ƒï¼šç”¨äºè¿æ¥ OV5695**
- rockchip: mppvideodec: Rockchip MPP Video Decoder
- rockchip: mpph264enc: Rockchip Mpp H264 Encoder

å¦‚æœæ²¡æœ‰ rkispï¼Œè¯´æ˜ä½ çƒ§å½•çš„å›ºä»¶å¯èƒ½ä¸æ˜¯å®˜æ–¹é€‚é…æ‘„åƒå¤´çš„ç‰ˆæœ¬ï¼Œæˆ–è€…éœ€è¦è”ç³»æ¿å‚è·å–æ”¯æŒç¡¬ä»¶åŠ é€Ÿçš„ GStreamer åº“ã€‚ä¸è¿‡é€šå¸¸å¼€å‘æ¿å‚å•†æä¾›çš„ Ubuntu é•œåƒé»˜è®¤éƒ½æœ‰ã€‚

å¦‚æœæ’ä»¶ä¸å­˜åœ¨ â†’ å®‰è£…ï¼š

```bash
apt-get install gstreamer1.0-rockchip
apt-get install gstreamer1.0-plugins-base
```

**éªŒè¯ Opencv æ˜¯å¦æ”¯æŒ GStreamer**

è¿™æ˜¯æœ€å®¹æ˜“è¢«å‘çš„ä¸€æ­¥ã€‚**å¹¶ä¸æ˜¯æ‰€æœ‰çš„ OpenCV éƒ½æ”¯æŒ GStreamer**ã€‚å¦‚æœä½ æ˜¯ç”¨ pip install opencv-python å®‰è£…çš„ï¼Œå®ƒå¯èƒ½ä¸æ”¯æŒ GStreamerã€‚å»ºè®®ä½¿ç”¨ apt å®‰è£…ç³»ç»Ÿçº§çš„ OpenCVï¼ˆé€šå¸¸é’ˆå¯¹æ¿å­ä¼˜åŒ–è¿‡ï¼‰

```bash
sudo apt-get install python3-opencv
```

**éªŒè¯è„šæœ¬**ï¼š

åœ¨ç»ˆç«¯è¿›å…¥ Python3ï¼Œè¾“å…¥ä»¥ä¸‹ä»£ç æ£€æŸ¥ï¼š

```python
import cv2
print(cv2.getBuildInformation())
```

åœ¨è¾“å‡ºçš„ä¸€å¤§å †ä¿¡æ¯ä¸­ï¼Œæ‰¾åˆ° **Video I/O** éƒ¨åˆ†ï¼Œæ£€æŸ¥ GStreamer åé¢æ˜¯å¦æ˜¯ YESã€‚

å¦‚æœæ˜¯ NO / N/Aï¼Œä½ éœ€è¦å¸è½½å½“å‰çš„ OpenCVï¼Œé‡æ–°ç¼–è¯‘æˆ–å¯»æ‰¾æ”¯æŒ GStreamer çš„ç‰ˆæœ¬ï¼ˆé€šå¸¸ sudo apt install python3-opencv å®‰è£…çš„ç‰ˆæœ¬æ˜¯æ”¯æŒçš„ï¼‰ã€‚



**æ–¹æ¡ˆ C**ï¼šæ‰‹åŠ¨æµ‹è¯•ç®¡é“

```bash
gst-launch-1.0 rkisp device=/dev/video0 io-mode=1 ! \
  video/x-raw,format=NV12,width=640,height=480,framerate=30/1 ! \
  videoconvert ! autovideosink
```

å¦‚æœèƒ½çœ‹åˆ°ç”»é¢ â†’ ç®¡é“é…ç½®æ­£ç¡®ï¼Œé—®é¢˜åœ¨ OpenCV é›†æˆ
å¦‚æœçœ‹ä¸åˆ°ç”»é¢ â†’ æ£€æŸ¥è®¾å¤‡ç´¢å¼•æˆ–ç®¡é“é…ç½®

**æ–¹æ¡ˆ D**ï¼šä¸´æ—¶é™çº§
```python
# backend/config.py
CAMERA_MODE = 'opencv'  # å…ˆç”¨ OpenCV ç¡®è®¤ç¡¬ä»¶æ­£å¸¸
```

---

#### é—®é¢˜ 3ï¼šç”»é¢åç»¿/è‰²å½©å¼‚å¸¸

**ç°è±¡**ï¼š
- ç”»é¢æ•´ä½“åç»¿
- è‰²æ¸©ä¸å¯¹
- ç”»é¢å‘ç™½/è¿‡æ›

**åŸå› **ï¼šISP æœªæ­£å¸¸å·¥ä½œï¼Œä½¿ç”¨ Raw Sensor æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼š

**1. æ£€æŸ¥ GStreamer ç®¡é“é…ç½®**
```python
# backend/config.py
GSTREAMER_PIPELINE = (
    "rkisp device=/dev/video{index} io-mode=1 ! "  # â† ç¡®è®¤è¿™æ˜¯ ISP è®¾å¤‡
    "video/x-raw,format=NV12,width={width},height={height},framerate={fps}/1 ! "
    "videoconvert ! "
    "video/x-raw,format=BGR ! appsink"
)
```

**2. å°è¯•ä¸åŒçš„è®¾å¤‡ç´¢å¼•**
```python
# å¦‚æœ video0 ä¸æ˜¯ ISPï¼Œå°è¯• video1
CAMERA_INDEX = 1
```

**3. å°è¯•ä¸åŒçš„æ ¼å¼**
```python
# æŸäº›é…ç½®å¯èƒ½éœ€è¦ YUYV
GSTREAMER_PIPELINE = (
    "rkisp device=/dev/video{index} io-mode=1 ! "
    "video/x-raw,format=YUYV,width={width},height={height},framerate={fps}/1 ! "
    "videoconvert ! video/x-raw,format=BGR ! appsink"
)
```

**4. å¦‚æœæ— æ³•è§£å†³**
```python
# ä¸´æ—¶ä½¿ç”¨ OpenCV æ¨¡å¼
# è™½ç„¶å¯èƒ½åç»¿ï¼Œä½†äººè„¸æ£€æµ‹ä¸»è¦ä¾èµ–ç°åº¦ç‰¹å¾ï¼Œä¸å½±å“åŠŸèƒ½
CAMERA_MODE = 'opencv'
```

---

#### é—®é¢˜ 4ï¼šæ€§èƒ½ä¸è¶³ï¼ˆCPU å ç”¨é«˜ã€å¸§ç‡ä½ï¼‰

**ç—‡çŠ¶**ï¼š
- è§†é¢‘æµå¡é¡¿
- CPU å ç”¨ > 50%
- ç§»åŠ¨æ£€æµ‹å»¶è¿Ÿ
- åå°çº¿ç¨‹å“åº”æ…¢

**æ’æŸ¥æ­¥éª¤**ï¼š

**1. æ£€æŸ¥å½“å‰ä½¿ç”¨çš„æ¨¡å¼**

æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼š
```bash
journalctl -u smart-door | grep "Mode:"

# è¾“å‡ºç¤ºä¾‹ï¼š
# [Camera]   Mode:      opencv  â† å¦‚æœæ˜¯ opencvï¼Œæ²¡ç”¨ç¡¬ä»¶åŠ é€Ÿ
```

æˆ–æ·»åŠ  API æŸ¥è¯¢ï¼ˆåœ¨ `routers/face.py` æˆ–æ–°å»ºè·¯ç”±ï¼‰ï¼š
```python
@router.get("/camera_info")
async def get_camera_info():
    camera = get_camera()
    return camera.get_info()
```

è®¿é—®ï¼š`curl http://localhost:8000/api/face/camera_info`
```json
{
  "mode": "opencv",  â† å…³é”®ä¿¡æ¯
  "index": 0,
  "width": 640,
  "height": 480,
  "fps": 30
}
```

**2. å¦‚æœæ˜¯ OpenCV æ¨¡å¼**

**æ–¹æ¡ˆ A**ï¼šå°è¯•åˆ‡æ¢åˆ° GStreamer
```python
CAMERA_MODE = 'gstreamer'  # å¼ºåˆ¶ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ
```

**æ–¹æ¡ˆ B**ï¼šé™ä½åˆ†è¾¨ç‡
```python
CAMERA_WIDTH = 640   # ä» 1280 é™åˆ° 640
CAMERA_HEIGHT = 480  # ä» 720 é™åˆ° 480
```

**æ–¹æ¡ˆ C**ï¼šé™ä½åå°æ£€æµ‹é¢‘ç‡
```python
# backend/config.py
CHECK_INTERVAL = 0.2  # ä» 0.1 æ”¹ä¸º 0.2ï¼ˆæ¯ç§’æ£€æµ‹5æ¬¡è€Œä¸æ˜¯10æ¬¡ï¼‰
```

**3. å¦‚æœæ˜¯ GStreamer æ¨¡å¼ä»ç„¶å¡é¡¿**

å¯èƒ½æ˜¯åˆ†è¾¨ç‡è¿‡é«˜ï¼š
```python
CAMERA_WIDTH = 640   # é™ä½åˆ†è¾¨ç‡
CAMERA_HEIGHT = 480
```

---

### 6.6 RK3568 è®¾å¤‡æ˜ å°„è¯´æ˜

#### å…¸å‹çš„è®¾å¤‡å¸ƒå±€

RK3568 ä¸Šé€šå¸¸æœ‰å¤šä¸ª video è®¾å¤‡ï¼š

```bash
ls -l /dev/video*

# è¾“å‡ºç¤ºä¾‹ï¼š
# /dev/video0  â†’ rkisp-isp-subdev (ISP å­è®¾å¤‡)
# /dev/video1  â†’ rkisp_mainpath (ISP ä¸»è·¯å¾„è¾“å‡º)
# /dev/video11 â†’ rkvenc (ç¡¬ä»¶ç¼–ç å™¨)
# /dev/video21 â†’ OV5695 Sensor (Raw ä¼ æ„Ÿå™¨)
```

#### å“ªä¸ªè®¾å¤‡æ˜¯æ­£ç¡®çš„ï¼Ÿ

| æ¨¡å¼ | åº”ä½¿ç”¨è®¾å¤‡ | è¯´æ˜ |
|------|----------|------|
| **GStreamer** | video0 æˆ– video1 | ISP å…¥å£/å‡ºå£ |
| **OpenCV** | video1 æˆ– video21 | ISP è¾“å‡ºæˆ– Sensor |

**ä¸ºä»€ä¹ˆä¸åŒï¼Ÿ**
- **GStreamer ç®¡é“**ï¼šé€šè¿‡ `rkisp` æ’ä»¶è‡ªåŠ¨è¿æ¥ ISP
- **OpenCV ç›´æ¥è®¿é—®**ï¼šéœ€è¦æ‰¾åˆ°å·²å¤„ç†å¥½çš„è§†é¢‘æµèŠ‚ç‚¹

#### æ‰‹åŠ¨æŸ¥æ‰¾æ­£ç¡®è®¾å¤‡

**æ–¹æ³• 1**ï¼šä½¿ç”¨ v4l2-ctl æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯
```bash
for i in 0 1 11 21; do
  echo "=== /dev/video$i ==="
  v4l2-ctl -d /dev/video$i --all 2>&1 | grep -E "Driver|Card|Formats"
done
```

**æ–¹æ³• 2**ï¼šä½¿ç”¨ OpenCV æµ‹è¯•è„šæœ¬

```python
#!/usr/bin/env python3
import cv2

for index in [0, 1, 11, 21]:
    print(f"\n=== Testing /dev/video{index} ===")
    cap = cv2.VideoCapture(index)

    if not cap.isOpened():
        print("  âŒ Cannot open")
        continue

    # å°è¯•è¯»å–ä¸€å¸§
    ret, frame = cap.read()
    if ret:
        print(f"  âœ… SUCCESS")
        print(f"     Shape: {frame.shape}")
        print(f"     Width: {cap.get(cv2.CAP_PROP_FRAME_WIDTH)}")
        print(f"     Height: {cap.get(cv2.CAP_PROP_FRAME_HEIGHT)}")
    else:
        print("  âŒ Opened but cannot read frames")

    cap.release()
```

ä¿å­˜ä¸º `test_camera.py`ï¼Œè¿è¡Œï¼š
```bash
python3 test_camera.py
```

æ‰¾åˆ°å¯ç”¨è®¾å¤‡åæ›´æ–°é…ç½®ã€‚

---

### 6.7 æ€§èƒ½å¯¹æ¯”å‚è€ƒ

| æŒ‡æ ‡ | GStreamer æ¨¡å¼ | OpenCV æ¨¡å¼ |
|------|---------------|------------|
| **CPU å ç”¨** (640x480@30fps) | 5-10% | 30-40% |
| **CPU å ç”¨** (1280x720@30fps) | 10-15% | 60-80% |
| **æœ€å¤§åˆ†è¾¨ç‡** | 1920x1080@30fps | 640x480@30fps |
| **è‰²å½©å‡†ç¡®åº¦** | æ­£å¸¸ï¼ˆISP å¤„ç†ï¼‰ | å¯èƒ½åç»¿ |
| **å¯åŠ¨æ—¶é—´** | å¿« | ä¸­ç­‰ |
| **å…¼å®¹æ€§** | ä»… RK3568 | é€šç”¨ |
| **è°ƒè¯•éš¾åº¦** | è¾ƒé«˜ | ä½ |
| **å»¶è¿Ÿ** | ä½ (< 50ms) | ä¸­ç­‰ (50-100ms) |

**å»ºè®®**ï¼š
- ç”Ÿäº§ç¯å¢ƒä¼˜å…ˆ GStreamerï¼ˆæ€§èƒ½æœ€ä½³ï¼‰
- å¼€å‘ç¯å¢ƒä½¿ç”¨ OpenCVï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰
- æ€§èƒ½ä¸è¶³æ—¶é™ä½åˆ†è¾¨ç‡ï¼ˆä» 1280x720 â†’ 640x480ï¼‰

---

### 6.8 æ•…éšœå¤„ç†æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥ï¼Ÿ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                 â”‚
         â†“                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GStreamer failed     â”‚    â”‚ OpenCV failed on all   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                 â”‚
         â†“                                 â†“
  åˆ‡æ¢åˆ° OpenCV æ¨¡å¼              æ£€æŸ¥ç¡¬ä»¶è¿æ¥
  CAMERA_MODE = 'opencv'           â”‚
         â”‚                         â”œâ”€ ls /dev/video*
         â†“                         â”œâ”€ dmesg | grep ov5695
     é‡å¯ç³»ç»Ÿ                      â””â”€ v4l2-ctl --list-devices
         â”‚                                 â”‚
         â†“                                 â†“
    ä»ç„¶å¤±è´¥ï¼Ÿ                      æ‰¾åˆ°å¯ç”¨è®¾å¤‡ç´¢å¼•
         â”‚                         (å¦‚ video1 æˆ– video21)
         â†“                                 â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â†“
  â”‚ æ£€æŸ¥ç¡¬ä»¶        â”‚        æ›´æ–°é…ç½®
  â”‚                 â”‚        CAMERA_INDEX = 1
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        CAMERA_FALLBACK_INDICES = [1]
                                       â”‚
                                       â†“
                                   é‡å¯ç³»ç»Ÿ
                                       â”‚
                                       â†“
                                    æˆåŠŸ âœ…
```

---

### 6.9 éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²åˆ° RK3568 å‰ï¼Œè¯·ç¡®è®¤ï¼š

**ç¡¬ä»¶æ£€æŸ¥**ï¼š

- [ ] æ‘„åƒå¤´æ’çº¿è¿æ¥ç‰¢å›º
- [ ] æ‘„åƒå¤´ç”µæºä¾›ç”µæ­£å¸¸
- [ ] RK3568 æ­£å¸¸å¼€æœº

**è½¯ä»¶æ£€æŸ¥**ï¼š
- [ ] é©±åŠ¨å·²åŠ è½½ï¼ˆ`dmesg | grep ov5695`ï¼‰
- [ ] è®¾å¤‡èŠ‚ç‚¹å­˜åœ¨ï¼ˆ`ls /dev/video*`ï¼‰
- [ ] OpenCV å·²å®‰è£…ï¼ˆ`python3 -c "import cv2"`ï¼‰
- [ ] ï¼ˆå¯é€‰ï¼‰GStreamer æ’ä»¶å·²å®‰è£…

**é…ç½®æ£€æŸ¥**ï¼š
- [ ] `CAMERA_MODE` å·²è®¾ç½®ï¼ˆæ¨è `'auto'`ï¼‰
- [ ] `CAMERA_INDEX` å·²è®¾ç½®ï¼ˆé»˜è®¤ `0`ï¼‰
- [ ] åˆ†è¾¨ç‡åˆç†ï¼ˆæ¨è `640x480`ï¼‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. å¯åŠ¨ç³»ç»Ÿï¼š`python -m uvicorn backend.main:app`
2. æŸ¥çœ‹æ—¥å¿—ï¼šç¡®è®¤æ‘„åƒå¤´æˆåŠŸåˆå§‹åŒ–
3. è®¿é—®è§†é¢‘æµï¼š`http://ip:8000/api/video_stream`
4. æµ‹è¯•äººè„¸å½•å…¥ï¼šç¡®è®¤ç”»é¢æ­£å¸¸

---

### 6.10 æ€»ç»“ä¸å…³é”®åŸåˆ™

**å…³é”®åŸåˆ™**ï¼š
1. âœ… **é»˜è®¤ä½¿ç”¨ `'auto'` æ¨¡å¼**ï¼ˆè‡ªåŠ¨é€‚é…ï¼Œå…¼é¡¾æ€§èƒ½å’Œå…¼å®¹æ€§ï¼‰
2. âœ… **é‡åˆ°é—®é¢˜ç«‹å³åˆ‡æ¢åˆ° `'opencv'`**ï¼ˆä¿è¯ç³»ç»Ÿå¯ç”¨ï¼‰
3. âœ… **ç¨³å®šåå¯ä¼˜åŒ–ä¸º `'gstreamer'`**ï¼ˆå……åˆ†åˆ©ç”¨ç¡¬ä»¶ï¼‰
4. âœ… **æŸ¥çœ‹å¯åŠ¨æ—¥å¿—æ’æŸ¥é—®é¢˜**ï¼ˆæ‰€æœ‰å…³é”®ä¿¡æ¯éƒ½åœ¨æ—¥å¿—ä¸­ï¼‰
5. âœ… **æ ¹æ®å®é™…æ€§èƒ½è°ƒæ•´åˆ†è¾¨ç‡**ï¼ˆ640x480 é—¨ç¦åœºæ™¯è¶³å¤Ÿï¼‰

**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š
- ä¸»é…ç½®ï¼š`backend/config.py`
- å®ç°ä»£ç ï¼š`backend/core/camera.py`
- æœ¬æ–‡æ¡£ï¼š`backend/docs/ov5695æ¥å…¥æ–‡æ¡£.md`

**æµ‹è¯•å‘½ä»¤**ï¼š
```bash
# æµ‹è¯•é…ç½®åŠ è½½
python -m backend.config

# å¯åŠ¨ç³»ç»Ÿ
python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000

# æŸ¥çœ‹æ‘„åƒå¤´ä¿¡æ¯ï¼ˆéœ€æ·»åŠ è·¯ç”±ï¼‰
curl http://localhost:8000/api/camera_info

# æŸ¥çœ‹è§†é¢‘æµ
curl http://localhost:8000/api/video_stream --output test.mjpeg
```

**é‡åˆ°é—®é¢˜æ—¶**ï¼š
1. å…ˆåˆ‡æ¢åˆ° `'opencv'` æ¨¡å¼ç¡®ä¿ç³»ç»Ÿèƒ½å¯åŠ¨
2. æŸ¥çœ‹æ—¥å¿—æ‰¾åˆ°å¯ç”¨çš„è®¾å¤‡ç´¢å¼•
3. å›ºå®šè®¾å¤‡ç´¢å¼•é¿å…é‡å¤å°è¯•
4. ç¨³å®šåå†å°è¯• `'gstreamer'` æ¨¡å¼ä¼˜åŒ–æ€§èƒ½

