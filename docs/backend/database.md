## 数据库设计

后端开发第一阶段：编写底层数据库 SQLite

## Situation

目前已经拥有人脸识别模块，PR #13 。以及核心引擎 backend\core\face_engine.py。
**该引擎只涉及两个 API**：
1. `/api/face/capture` ：使用人脸识别模块处理人脸图片，录入向量数据：手机发送 HTTP 指令 -> RK3568 截帧 -> 人脸识别模块处理得到向量 -> 存入数据库
2. `/api/face/recognize` ：管理员远程登录后在手机上测试系统：管理员在手机/电脑上传一张图片 -> 发送 HTTP 请求 -> RK3568 计算并返回 JSON 结果 ("这是张三，相似度 0.9")

## Task

实现数据库 SQLite 的两张表，一张存“人”，一张存“事”。


### 1. 管理员信息表 (`admin`)
这张表负责存储管理员的信息

| 字段名       | 数据类型 | 必填 | 说明                                                         |
| :----------- | :------- | :--- | :----------------------------------------------------------- |
| **id**       | INTEGER  | 是   | **主键**，自增。用户的唯一标识                               |
| **name**     | TEXT     | 是   | 用户名（唯一），用于前端显示和管理                           |
| **password** | TEXT     | 否   | **传统密码的哈希值**。用于键盘开门（存储 SHA-256 哈希，绝不存明文） |

### 2.  人脸特征向量表
存储对应用户的人脸向量

| 字段名             | 数据类型 | 必填 | 说明                          |
| :----------------- | :------- | :--- | :---------------------------- |
| **id**             | INTEGER  | 是   | **主键**，自增。              |
| **name**           | TEXT     | 是   | 录入人脸的姓名                |
| **feature_vector** | BLOB     | 是   | 存储512维特征向量的二进制数据 |


## Steps

请按照以下顺序在 `backend/database/` 目录下进行开发：

### 步骤 1：建立数据库连接管理器 (`db_manager.py`)
不要每次操作都写 `connect` 和 `close`，写一个 Python 类来封装这些底层操作
*   **功能要求**：
    *   实现单例模式或上下文管理器 (`with` 语法)，确保多线程（后台线程 vs API 线程）访问时的安全性
    *   默认开启 `check_same_thread=False` 参数，允许不同线程访问同一个连接对象

### 步骤 2：编写初始化脚本 (建表与种子数据)
系统第一次启动时，`.db` 文件是不存在的。你需要写一个 `init_db` 函数
*   **逻辑**：
    1.  检查 `smart_door.db` 是否存在
    2.  如果不存在，执行 SQL `CREATE TABLE` 语句创建上述两张表
    3.  **关键点**：自动插入一个**默认管理员账号**（例如用户名为 `admin`，密码为 `123456` 的哈希），否则系统跑起来后没法登录 Web 面板

### 步骤 3：实现特征向量的存取转换工具
这是最容易出错的地方，需要编写两个辅助函数，专门处理 Numpy 和 SQLite 之间的转换。
*   **存入 (`To_SQL`)**：接收 Numpy 数组 -> 调用 `.tobytes()` -> 存入 BLOB
*   **读取 (`From_SQL`)**：读取 BLOB -> 调用 `np.frombuffer()` -> 还原为 Numpy 数组（注意指定 `dtype=np.float32`）

### 步骤 4：封装 CRUD 操作接口
为了让上层业务逻辑（FastAPI 和 后台线程）代码干净，不要在业务层写 SQL 语句。请在管理器中暴露以下方法：
*   `add_user(username, pin, feature_bytes)`
*   `get_all_users()` -> 返回包含所有特征向量的列表（供人脸识别引擎加载到内存中）
*   `verify_pin(input_pin)` -> 验证键盘密码
*   `log_access(user_id, method, status)` -> 写入日志

---

## Checklist

1.  [ ] 在 `backend/database/` 下创建 `db_manager.py`
2.  [ ] 编写 SQL 建表语句（DDL）
3.  [ ] 编写 Numpy Array <-> Bytes 的转换工具函数
4.  [ ] 编写“初始化”逻辑，确保系统启动时自动生成 `admin` 账号
5.  [ ] 编写一个简单的 `main` 测试函数，测试插入一个假用户并能成功读取出来