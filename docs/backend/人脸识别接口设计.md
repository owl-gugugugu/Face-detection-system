# äººè„¸è¯†åˆ«æ¥å£è®¾è®¡æ–‡æ¡£

æœ¬æ–‡æ¡£å®šä¹‰åç«¯ï¼ˆFastAPIï¼‰ä¸äººè„¸è¯†åˆ«æ¨¡å—ï¼ˆC++ .so åº“ï¼‰çš„å°è£…æ¥å£è§„èŒƒã€‚

---

## 1. åˆ†å±‚æ¶æ„

é‡‡ç”¨ä¸‰å±‚æ¶æ„ï¼Œæ¸…æ™°åˆ†ç¦»èŒè´£ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Layer 3: FastAPI è·¯ç”±              â”‚
â”‚   - æ¥æ”¶ HTTP è¯·æ±‚                    â”‚
â”‚   - è°ƒç”¨ FaceEngine                  â”‚
â”‚   - æ•°æ®åº“æŸ¥è¯¢/å­˜å‚¨                   â”‚
â”‚   - è¿”å› JSON å“åº”                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Layer 2: Python Wrapper            â”‚
â”‚   (backend/core/face_engine.py)     â”‚
â”‚   - åŠ è½½ .so åŠ¨æ€åº“                   â”‚
â”‚   - ç®¡ç† ctypes å†…å­˜æŒ‡é’ˆ              â”‚
â”‚   - æä¾› Python å‹å¥½æ¥å£              â”‚
â”‚   - è¾“å…¥: bytes â†’ è¾“å‡º: List[float]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ ctypes
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Layer 1: C++ åŠ¨æ€åº“                â”‚
â”‚   (libface_engine.so)               â”‚
â”‚   - äººè„¸æ£€æµ‹ (RetinaFace)            â”‚
â”‚   - äººè„¸å¯¹é½ (ä»¿å°„å˜æ¢)               â”‚
â”‚   - ç‰¹å¾æå– (MobileFaceNet)         â”‚
â”‚   - è¾“å‡º: 512ç»´ç‰¹å¾å‘é‡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èŒè´£åˆ’åˆ†**ï¼š
- **Layer 1 (C++)**: çº¯è®¡ç®—ï¼Œè´Ÿè´£å›¾åƒå¤„ç†å’Œæ¨¡å‹æ¨ç†
- **Layer 2 (Python Wrapper)**: çº¯ç¿»è¯‘ï¼Œè´Ÿè´£ Python â†” C++ æ•°æ®è½¬æ¢
- **Layer 3 (FastAPI)**: ä¸šåŠ¡é€»è¾‘ï¼Œè´Ÿè´£æ•°æ®åº“ã€æƒé™ã€HTTP å“åº”

**é‡è¦åŸåˆ™**ï¼šWrapper å±‚**ä¸åº”åŒ…å«**ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼ˆæ•°æ®åº“ã€æƒé™ã€å¼€é—¨æ§åˆ¶ç­‰ï¼‰ã€‚

---

## 2. Python Wrapper å®ç°è§„èŒƒ

### 2.1 æ–‡ä»¶ä½ç½®

```
backend/core/face_engine.py
```

### 2.2 å¿…é¡»å®ç°çš„ 5 ä¸ªæ ¸å¿ƒéƒ¨åˆ†

#### Part 1: åŠ¨æ€åº“åŠ è½½ä¸è·¯å¾„ç®¡ç†

**åŠŸèƒ½**ï¼š
- å®šä½ `libface_engine.so` å’Œä¸¤ä¸ª RKNN æ¨¡å‹æ–‡ä»¶
- ä½¿ç”¨ `ctypes.CDLL` åŠ è½½åŠ¨æ€åº“
- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

**å®ç°ç¤ºä¾‹**ï¼š
```python
backend_dir = Path(__file__).parent.parent.resolve()
project_root = backend_dir.parent

lib_path = project_root / "face_detection" / "build" / "libface_engine.so"
retinaface_model = project_root / "face_detection" / "models" / "RetinaFace.rknn"
mobilefacenet_model = project_root / "face_detection" / "models" / "mobilefacenet.rknn"

# æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
if not lib_path.exists():
    raise FileNotFoundError(f"Library not found: {lib_path}")

# åŠ è½½åŠ¨æ€åº“
self.lib = ctypes.CDLL(str(lib_path))
```

**å…³é”®ç‚¹**ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œé¿å…ç›¸å¯¹è·¯å¾„å¯¼è‡´çš„éƒ¨ç½²é—®é¢˜ã€‚

---

#### Part 2: C å‡½æ•°çš„å‚æ•°ç±»å‹å®šä¹‰

**åŠŸèƒ½**ï¼šå‘Šè¯‰ Python æ¯ä¸ª C å‡½æ•°çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ã€‚**è¿™æ˜¯æœ€å…³é”®çš„æ­¥éª¤ï¼Œé…ç½®é”™è¯¯ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚**

**å¿…é¡»å®šä¹‰çš„ 5 ä¸ª C å‡½æ•°**ï¼š

| C å‡½æ•° | å‚æ•°ç±»å‹ | è¿”å›å€¼ç±»å‹ |
|--------|---------|-----------|
| `FaceEngine_Create` | æ— å‚æ•° | `c_void_p` (å¼•æ“æŒ‡é’ˆ) |
| `FaceEngine_Init` | `c_void_p`, `c_char_p`, `c_char_p` | `c_int` (çŠ¶æ€ç ) |
| `FaceEngine_ExtractFeature` | `c_void_p`, `POINTER(c_ubyte)`, `c_int`, `POINTER(c_float)` | `c_int` (çŠ¶æ€ç ) |
| `FaceEngine_Destroy` | `c_void_p` | `None` |
| `FaceEngine_CosineSimilarity` | `POINTER(c_float)`, `POINTER(c_float)` | `c_float` (ç›¸ä¼¼åº¦) |

**å®ç°ç¤ºä¾‹**ï¼š
```python
# void* FaceEngine_Create()
self.lib.FaceEngine_Create.restype = ctypes.c_void_p
self.lib.FaceEngine_Create.argtypes = []

# int FaceEngine_Init(void* engine, const char* model1, const char* model2)
self.lib.FaceEngine_Init.restype = ctypes.c_int
self.lib.FaceEngine_Init.argtypes = [
    ctypes.c_void_p,     # engine
    ctypes.c_char_p,     # retinaface_model
    ctypes.c_char_p      # mobilefacenet_model
]

# int FaceEngine_ExtractFeature(void* engine, unsigned char* data, int len, float* out)
self.lib.FaceEngine_ExtractFeature.restype = ctypes.c_int
self.lib.FaceEngine_ExtractFeature.argtypes = [
    ctypes.c_void_p,                   # engine
    ctypes.POINTER(ctypes.c_ubyte),    # jpeg_data
    ctypes.c_int,                      # data_len
    ctypes.POINTER(ctypes.c_float)     # feature_512
]

# void FaceEngine_Destroy(void* engine)
self.lib.FaceEngine_Destroy.restype = None
self.lib.FaceEngine_Destroy.argtypes = [ctypes.c_void_p]

# float FaceEngine_CosineSimilarity(const float* emb1, const float* emb2)
self.lib.FaceEngine_CosineSimilarity.restype = ctypes.c_float
self.lib.FaceEngine_CosineSimilarity.argtypes = [
    ctypes.POINTER(ctypes.c_float),    # emb1
    ctypes.POINTER(ctypes.c_float)     # emb2
]
```

---

#### Part 3: åˆå§‹åŒ–æ–¹æ³• (__init__)

**åŠŸèƒ½**ï¼š
- åˆ›å»º C++ å¼•æ“å®ä¾‹
- åŠ è½½ä¸¤ä¸ª RKNN æ¨¡å‹
- ä¿å­˜å¼•æ“æŒ‡é’ˆä¾›åç»­è°ƒç”¨ä½¿ç”¨

**æµç¨‹**ï¼š
```python
def __init__(self):
    # 1. åŠ è½½åŠ¨æ€åº“ï¼ˆPart 1ï¼‰
    # 2. å®šä¹‰å‡½æ•°ç±»å‹ï¼ˆPart 2ï¼‰

    # 3. åˆ›å»ºå¼•æ“å®ä¾‹
    self.engine_ptr = self.lib.FaceEngine_Create()
    if not self.engine_ptr:
        raise RuntimeError("Failed to create FaceEngine instance")

    # 4. åˆå§‹åŒ–æ¨¡å‹
    ret = self.lib.FaceEngine_Init(
        self.engine_ptr,
        str(retinaface_model).encode('utf-8'),
        str(mobilefacenet_model).encode('utf-8')
    )

    if ret != 0:
        self.lib.FaceEngine_Destroy(self.engine_ptr)
        raise RuntimeError(f"Failed to initialize FaceEngine (ret={ret})")
```

**å…³é”®ç‚¹**ï¼š
- `engine_ptr` å¿…é¡»ä¿å­˜ä¸ºå®ä¾‹å˜é‡ï¼Œåç»­æ‰€æœ‰æ“ä½œéƒ½éœ€è¦å®ƒ
- æ¨¡å‹è·¯å¾„å¿…é¡»ç¼–ç ä¸º UTF-8 å­—èŠ‚ä¸²
- åˆå§‹åŒ–å¤±è´¥æ—¶è¦é‡Šæ”¾å·²åˆ›å»ºçš„å¼•æ“

---

#### Part 4: æ ¸å¿ƒåŠŸèƒ½æ–¹æ³• (extract_feature)

**åŠŸèƒ½**ï¼šFastAPI ä¸äººè„¸è¯†åˆ«æ¨¡å—çš„**å”¯ä¸€äº¤äº’ç‚¹**ã€‚

**æ¥å£å®šä¹‰**ï¼š
```python
def extract_feature(self, image_bytes: bytes) -> Optional[List[float]]:
    """
    æå–äººè„¸ç‰¹å¾å‘é‡

    Args:
        image_bytes: å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆJPEG/PNGæ ¼å¼ï¼‰

    Returns:
        List[float]: 512ç»´ç‰¹å¾å‘é‡ï¼ˆæˆåŠŸï¼‰
        None: æœªæ£€æµ‹åˆ°äººè„¸æˆ–å¤„ç†å¤±è´¥
    """
```

**å®ç°æµç¨‹**ï¼š
```python
# 1. è½¬æ¢ä¸º ctypes æ•°ç»„ï¼ˆé›¶æ‹·è´ï¼‰
jpeg_array = np.frombuffer(image_bytes, dtype=np.uint8)
jpeg_ptr = jpeg_array.ctypes.data_as(ctypes.POINTER(ctypes.c_ubyte))

# 2. é¢„åˆ†é…è¾“å‡ºç¼“å†²åŒº
feature_512 = np.zeros(512, dtype=np.float32)
feature_ptr = feature_512.ctypes.data_as(ctypes.POINTER(ctypes.c_float))

# 3. è°ƒç”¨ C++ å‡½æ•°
ret = self.lib.FaceEngine_ExtractFeature(
    self.engine_ptr,
    jpeg_ptr,
    len(image_bytes),
    feature_ptr
)

# 4. å¤„ç†è¿”å›å€¼
if ret == 0:
    return feature_512.tolist()  # æˆåŠŸ
elif ret == -1:
    return None  # æœªæ£€æµ‹åˆ°äººè„¸
else:
    return None  # å…¶ä»–é”™è¯¯
```

**è¿”å›å€¼è¯´æ˜**ï¼š
| C++ è¿”å›å€¼ | å«ä¹‰ | Python è¿”å› |
|-----------|------|------------|
| `0` | æˆåŠŸæå–ç‰¹å¾ | `List[float]` (512ç»´) |
| `-1` | æœªæ£€æµ‹åˆ°äººè„¸ | `None` |
| `-2` | å›¾åƒè§£ç å¤±è´¥ | `None` |
| å…¶ä»– | æ¨¡å‹æ¨ç†å¤±è´¥ | `None` |

---

#### Part 5: èµ„æºé‡Šæ”¾æ–¹æ³• (__del__)

**åŠŸèƒ½**ï¼šé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œé‡Šæ”¾ NPU ä¸Šä¸‹æ–‡å’Œå†…å­˜ã€‚

**å®ç°**ï¼š
```python
def __del__(self):
    """é‡Šæ”¾èµ„æºï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰"""
    if hasattr(self, 'engine_ptr') and self.engine_ptr:
        self.lib.FaceEngine_Destroy(self.engine_ptr)
        print("[FaceEngine] Engine destroyed")
```

**å…³é”®ç‚¹**ï¼š
- Python GC è°ƒç”¨ `__del__` æ—¶è‡ªåŠ¨é‡Šæ”¾ C++ èµ„æº
- å¿…é¡»æ£€æŸ¥ `engine_ptr` æ˜¯å¦å­˜åœ¨ï¼ˆé¿å…åˆå§‹åŒ–å¤±è´¥æ—¶æŠ¥é”™ï¼‰

---

### 2.3 é¢å¤–åŠŸèƒ½æ–¹æ³• (å¯é€‰)

#### compute_similarity - è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦

**åŠŸèƒ½**ï¼šè®¡ç®—ä¸¤ä¸ªç‰¹å¾å‘é‡çš„ç›¸ä¼¼åº¦ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯åœ¨ FastAPI å±‚ç”¨ numpy å®ç°ï¼‰ã€‚

**æ¥å£å®šä¹‰**ï¼š
```python
def compute_similarity(self, feature1: List[float], feature2: List[float]) -> float:
    """
    è®¡ç®—ä¸¤ä¸ªç‰¹å¾å‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦

    Args:
        feature1: 512ç»´ç‰¹å¾å‘é‡1
        feature2: 512ç»´ç‰¹å¾å‘é‡2

    Returns:
        float: ä½™å¼¦ç›¸ä¼¼åº¦ [0, 1]
    """
```

**å®ç°**ï¼š
```python
# è½¬æ¢ä¸º numpy æ•°ç»„
arr1 = np.array(feature1, dtype=np.float32)
arr2 = np.array(feature2, dtype=np.float32)

# è½¬æ¢ä¸º ctypes æŒ‡é’ˆ
ptr1 = arr1.ctypes.data_as(ctypes.POINTER(ctypes.c_float))
ptr2 = arr2.ctypes.data_as(ctypes.POINTER(ctypes.c_float))

# è°ƒç”¨ C++ å‡½æ•°
similarity = self.lib.FaceEngine_CosineSimilarity(ptr1, ptr2)
return float(similarity)
```

---

### 2.4 å•ä¾‹æ¨¡å¼å®ç°

**æ¨èå®ç°**ï¼šå…¨å±€åªåˆ›å»ºä¸€ä¸ªå¼•æ“å®ä¾‹ï¼Œé¿å…é‡å¤åŠ è½½æ¨¡å‹ã€‚

```python
class FaceEngine:
    _instance = None
    _initialized = False

    def __new__(cls):
        """å•ä¾‹æ¨¡å¼ï¼šç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªå¼•æ“å®ä¾‹"""
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance

    def __init__(self):
        if self._initialized:
            return
        # ... åˆå§‹åŒ–é€»è¾‘ ...
        self._initialized = True


# å…¨å±€å•ä¾‹è·å–å‡½æ•°ï¼ˆä¾› FastAPI ä½¿ç”¨ï¼‰
_face_engine_instance = None

def get_face_engine() -> FaceEngine:
    """è·å–å…¨å±€ FaceEngine å®ä¾‹"""
    global _face_engine_instance
    if _face_engine_instance is None:
        _face_engine_instance = FaceEngine()
    return _face_engine_instance
```

---

## 3. FastAPI æ¥å£è®¾è®¡

### 3.1 æ ¸å¿ƒæ¥å£

#### æ¥å£ 1: å½•å…¥äººè„¸

**è·¯ç”±**: `POST /api/face/register`

**åŠŸèƒ½**ï¼šæå–äººè„¸ç‰¹å¾å¹¶å­˜å…¥æ•°æ®åº“ã€‚

**æµç¨‹**ï¼š
```python
from fastapi import UploadFile
from backend.core.face_engine import get_face_engine

@app.post("/api/face/register")
async def register_face(file: UploadFile, name: str):
    # 1. è¯»å–å›¾ç‰‡
    image_bytes = await file.read()

    # 2. æå–ç‰¹å¾
    engine = get_face_engine()
    feature = engine.extract_feature(image_bytes)

    if not feature:
        return {"code": 400, "message": "æœªæ£€æµ‹åˆ°äººè„¸"}

    # 3. å­˜å…¥æ•°æ®åº“
    db.save_face(name=name, feature=feature)

    return {"code": 200, "message": "å½•å…¥æˆåŠŸ"}
```

---

#### æ¥å£ 2: äººè„¸è¯†åˆ«

**è·¯ç”±**: `POST /api/face/recognize`

**åŠŸèƒ½**ï¼šè¯†åˆ«å›¾ç‰‡ä¸­çš„äººè„¸ï¼ˆç”¨äºæµ‹è¯•ï¼Œå®é™…éƒ¨ç½²æ—¶ç”±å¼€å‘æ¿åå°çº¿ç¨‹å¤„ç†ï¼‰ã€‚

**æµç¨‹**ï¼š
```python
@app.post("/api/face/recognize")
async def recognize_face(file: UploadFile):
    # 1. è¯»å–å›¾ç‰‡
    image_bytes = await file.read()

    # 2. æå–ç‰¹å¾
    engine = get_face_engine()
    feature = engine.extract_feature(image_bytes)

    if not feature:
        return {"code": 400, "message": "æœªæ£€æµ‹åˆ°äººè„¸"}

    # 3. æŸ¥è¯¢æ•°æ®åº“ï¼Œè®¡ç®—ç›¸ä¼¼åº¦
    all_faces = db.get_all_faces()  # [(name, feature), ...]

    max_similarity = 0.0
    matched_name = None

    for name, stored_feature in all_faces:
        similarity = engine.compute_similarity(feature, stored_feature)
        if similarity > max_similarity:
            max_similarity = similarity
            matched_name = name

    # 4. åˆ¤æ–­æ˜¯å¦åŒ¹é…ï¼ˆé˜ˆå€¼ 0.6ï¼‰
    if max_similarity >= 0.6:
        return {
            "code": 200,
            "name": matched_name,
            "similarity": max_similarity
        }
    else:
        return {
            "code": 404,
            "message": "æœªåŒ¹é…åˆ°å·²æ³¨å†Œäººè„¸"
        }
```

---

## 4. å®Œæ•´æ•°æ®æµ

### 4.1 äººè„¸è¯†åˆ«æµç¨‹

```
å‰ç«¯/å¼€å‘æ¿
    â†“ HTTP POST (multipart/form-data)
FastAPI è·¯ç”±
    â†“ await file.read()
bytes å¯¹è±¡
    â†“ engine.extract_feature(bytes)
Python Wrapper (face_engine.py)
    â†“ ctypes ä¼ é€’å†…å­˜æŒ‡é’ˆ
C++ åŠ¨æ€åº“ (libface_engine.so)
    â”œâ”€ cv::imdecode (è§£ç )
    â”œâ”€ RetinaFace (æ£€æµ‹)
    â”œâ”€ align_face (å¯¹é½)
    â”œâ”€ MobileFaceNet (è¯†åˆ«)
    â””â”€ return feature[512]
    â†“ è¿”å›ç‰¹å¾å‘é‡
Python Wrapper
    â†“ .tolist()
FastAPI è·¯ç”±
    â”œâ”€ æŸ¥è¯¢æ•°æ®åº“
    â”œâ”€ è®¡ç®—ç›¸ä¼¼åº¦
    â””â”€ åŒ¹é…ç”¨æˆ·
    â†“ JSON å“åº”
å‰ç«¯/å¼€å‘æ¿
```

### 4.2 æ—¶é—´å¼€é”€ï¼ˆRK3568ï¼‰

| é˜¶æ®µ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| HTTP ä¸Šä¼  | ~50ms | å–å†³äºå›¾ç‰‡å¤§å°å’Œç½‘ç»œ |
| å›¾ç‰‡è§£ç  | ~15ms | OpenCV è§£ç  JPEG |
| RetinaFace æ¨ç† | ~60ms | NPU åŠ é€Ÿ |
| äººè„¸å¯¹é½ | ~5ms | ä»¿å°„å˜æ¢ |
| MobileFaceNet æ¨ç† | ~40ms | NPU åŠ é€Ÿ |
| æ•°æ®åº“æŸ¥è¯¢ | ~10ms | å–å†³äºæ³¨å†Œäººæ•° |
| **æ€»è®¡** | **~180ms** | å•æ¬¡è¯†åˆ« |

---

## 5. å®ç°çŠ¶æ€

### âœ… å·²å®Œæˆ

- âœ… Python Wrapper ç±»ï¼ˆ`backend/core/face_engine.py`ï¼‰
- âœ… 5 ä¸ª C å‡½æ•°å°è£…ï¼ˆCreate/Init/Extract/Destroy/CosineSimilarityï¼‰
- âœ… å•ä¾‹æ¨¡å¼å®ç°
- âœ… å®Œæ•´çš„ç±»å‹æ³¨è§£å’Œæ–‡æ¡£å­—ç¬¦ä¸²
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º

### ğŸ”„ å¾…å®ç°

- â³ FastAPI è·¯ç”±æ¥å£ï¼ˆ`/api/face/capture`, `/api/face/recognize`ï¼‰
- â³ æ•°æ®åº“æ¨¡å‹ï¼ˆå­˜å‚¨ç”¨æˆ·åå’Œç‰¹å¾å‘é‡ï¼‰
- â³ å¼€å‘æ¿åå°çº¿ç¨‹ï¼ˆå®æ—¶äººè„¸æ£€æµ‹ï¼‰

---

## 6. æ³¨æ„äº‹é¡¹

### 6.1 å†…å­˜ç®¡ç†

- âœ… **æ¨è**ï¼šä½¿ç”¨ `numpy` ç®¡ç†å†…å­˜ï¼ˆè‡ªåŠ¨é‡Šæ”¾ï¼‰
- âŒ **é¿å…**ï¼šæ‰‹åŠ¨ä½¿ç”¨ `ctypes.create_string_buffer`ï¼ˆå®¹æ˜“æ³„æ¼ï¼‰

### 6.2 çº¿ç¨‹å®‰å…¨

- C++ å¼•æ“**ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„**
- å¦‚æœ FastAPI ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œéœ€è¦åŠ é”ï¼š
  ```python
  import threading
  
  class FaceEngine:
      def __init__(self):
          self._lock = threading.Lock()
  
      def extract_feature(self, image_bytes):
          with self._lock:
              # ... è°ƒç”¨ C++ å‡½æ•° ...
  ```

### 6.3 é”™è¯¯å¤„ç†

- æ‰€æœ‰ C++ é”™è¯¯é€šè¿‡è¿”å›å€¼ä¼ é€’ï¼Œ**ä¸ä¼šæŠ›å‡º Python å¼‚å¸¸**
- Wrapper å±‚åº”æ£€æŸ¥è¿”å›å€¼ï¼Œå¹¶åœ¨å¿…è¦æ—¶è½¬æ¢ä¸º Python å¼‚å¸¸

### 6.4 æ€§èƒ½ä¼˜åŒ–

- âœ… ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼ˆé¿å…é‡å¤åŠ è½½æ¨¡å‹ï¼‰
- âœ… ä½¿ç”¨ `numpy.frombuffer`ï¼ˆé›¶æ‹·è´ï¼‰
- âœ… æ‰¹é‡è¯†åˆ«æ—¶å¤ç”¨å¼•æ“å®ä¾‹

---

## 7. å‚è€ƒæ–‡æ¡£

- C++ API è¯¦ç»†è§„èŒƒï¼š`face_detection/docs/format_out_in.md`
- æ•°æ®æµè¯¦è§£ï¼š`face_detection/docs/dataflow.md`
- æ¨¡å‹åŠŸèƒ½è¯´æ˜ï¼š`face_detection/docs/model_function.md`
