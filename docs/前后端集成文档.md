# 智能门禁系统 - 前后端集成文档

## 1. 项目架构概述

### 1.1 整体架构
```
SmartGaze
├── backend/                # 后端服务（FastAPI）
│   ├── main.py            # 应用入口
│   ├── config.py          # 配置文件
│   ├── routers/           # 路由模块
│   ├── core/              # 核心功能（摄像头、人脸识别）
│   ├── database/          # 数据库管理
│   └── utils/             # 工具函数
├── fronted/               # 前端页面（HTML + JS）
│   ├── templates/         # Jinja2 模板
│   └── static/            # 静态资源（CSS/JS/图片）
└── face_app/              # 人脸识别推理引擎（ARM 交叉编译）
```

### 1.2 技术栈

**后端技术栈：**

- FastAPI - Web 框架
- Uvicorn - ASGI 服务器
- SQLite - 数据库
- OpenCV - 图像处理
- PyJWT - JWT 认证
- Jinja2 - 模板引擎

**前端技术栈：**
- Bootstrap 5 - UI 框架
- Vanilla JavaScript - 前端逻辑
- Fetch API - HTTP 请求
- MJPEG - 视频流显示

### 1.3 运行模式

系统支持两种运行模式（通过 `backend/config.py` 中的 `DEV_MODE` 配置）：

- **开发模式（DEV_MODE = True）**：使用 Mock 模拟硬件，适合 PC 开发调试
- **生产模式（DEV_MODE = False）**：使用真实硬件，部署到 RK3568 开发板

---

## 2. API 接口规范

### 2.1 接口基础信息

- **Base URL**: `http://localhost:8000`
- **认证方式**: JWT Bearer Token
- **数据格式**: JSON
- **字符编码**: UTF-8

### 2.2 认证相关接口

#### 2.2.1 用户登录
```json
POST /api/login
Content-Type: application/json

请求体：
{
    "username": "admin",
    "password": "123456"
}

成功响应：
{
    "status": "success",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}

失败响应：
{
    "status": "error",
    "msg": "账号或密码错误"
}
```

#### 2.2.2 修改密码
```json
POST /api/change_login_password
Authorization: Bearer <token>
Content-Type: application/json

请求体：
{
    "new_password": "新密码"
}

成功响应：
{
    "status": "success",
    "msg": "密码修改成功"
}
```

### 2.3 人脸管理接口

#### 2.3.1 人脸录入
```json
POST /api/face/capture
Authorization: Bearer <token>
Content-Type: application/json

请求体：
{
    "username": "张三"
}

成功响应：
{
    "status": "success"
}

失败响应：
{
    "status": "error",
    "message": "No face detected"
}
```

#### 2.3.2 获取用户列表
```json
GET /api/face/list
Authorization: Bearer <token>

响应：
["张三", "李四", "王五"]
```

#### 2.3.3 删除用户
```json
DELETE /api/face/{name}
Authorization: Bearer <token>

成功响应：
{
    "status": "success"
}
```

#### 2.3.4 清空所有用户
```json
DELETE /api/face/reset
Authorization: Bearer <token>

成功响应：
{
    "status": "success"
}
```

### 2.4 门禁控制接口

#### 2.4.1 远程开门
```json
POST /api/unlock
Authorization: Bearer <token>

成功响应：
{
    "status": "success",
    "message": "Door unlock initiated"
}
```

### 2.5 视频流接口

#### 2.5.1 实时视频流
```json
GET /api/video_stream

响应类型：multipart/x-mixed-replace; boundary=frame
说明：返回 MJPEG 格式的实时视频流
```

---

## 3. 前端页面说明

### 3.1 页面路由

| 路径 | 页面 | 说明 |
|------|------|------|
| `/` | 根路径 | 重定向到登录页 |
| `/login` | 登录页面 | 管理员登录 |
| `/dashboard` | 主控制台 | 开门、修改密码 |
| `/face_dashboard` | 人脸管理 | 人脸功能入口 |
| `/face_input` | 人脸录入 | 录入新用户 |
| `/face_list` | 用户列表 | 查看和删除用户 |

### 3.2 认证流程

1. 用户在登录页输入用户名和密码
2. 前端发送 POST 请求到 `/api/login`
3. 后端验证成功后返回 JWT token
4. 前端将 token 存储到 `localStorage`
5. 后续请求在 Authorization Header 中携带 token

**前端认证代码示例：**
```javascript
// 登录
const response = await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
});
const data = await response.json();
localStorage.setItem('token', data.token);

// 携带 token 请求
const token = localStorage.getItem('token');
fetch('/api/unlock', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` }
});
```

### 3.3 视频流显示

前端使用 `<img>` 标签显示 MJPEG 视频流：

```html
<img src="/api/video_stream" alt="实时视频流">
```

浏览器会自动处理 MJPEG 流的解码和显示。

---

## 4. 数据库设计

### 4.1 管理员表（administrators）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| username | TEXT | 用户名，唯一 |
| password | TEXT | 密码（明文存储，仅用于课设） |

### 4.2 人脸特征表（face_features）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| name | TEXT | 用户姓名 |
| feature_vector | BLOB | 512 维人脸特征向量 |

---

## 5. 开发模式说明

### 5.1 Mock 模拟

开发模式下（`DEV_MODE = True`），系统使用 Mock 类模拟硬件：

**MockCamera（模拟摄像头）：**
- 返回带有 "Dev Mode - Mock Camera" 文字的灰色图像
- 包含时间戳显示
- 不依赖真实摄像头硬件

**MockFaceEngine（模拟人脸引擎）：**
- `extract_feature()` 返回固定的 512 维特征向量
- `compare_features()` 返回固定相似度 0.95
- 不依赖 ARM 编译的 .so 库

### 5.2 配置切换

修改 `backend/config.py` 中的 `DEV_MODE` 变量：

```python
# PC 开发调试
DEV_MODE = True

# RK3568 生产部署
DEV_MODE = False
```

---

## 6. 部署说明

### 6.1 开发环境部署（PC）

**1. 安装依赖：**
```bash
pip install -r backend/requirements.txt
```

**2. 配置开发模式：**
确保 `backend/config.py` 中 `DEV_MODE = True`

**3. 启动服务器：**
```bash
python backend/start_server.py
```

**4. 访问系统：**
浏览器打开 `http://localhost:8000`

**默认管理员账号：**
- 用户名：`admin`
- 密码：`123456`

### 6.2 生产环境部署（RK3568）

**1. 修改配置：**
```python
# backend/config.py
DEV_MODE = False  # 切换到生产模式
GPIO_DOOR_PIN = 17  # 配置门锁控制引脚
```

**2. 安装依赖：**
在 RK3568 上安装 Python 依赖和系统库

**3. 配置硬件：**
- 连接 OV5695 摄像头
- 连接门锁继电器到 GPIO
- 测试硬件连接

**4. 启动服务：**
```bash
python backend/start_server.py
```

**5. 配置开机自启：**
使用 systemd 或其他方式配置服务自动启动

---

## 7. 常见问题

### 7.1 422 Unprocessable Entity

**原因：** 前端发送的数据格式与后端期望的不匹配

**解决：** 确保后端接口使用了 Pydantic 模型接收 JSON 数据

### 7.2 视频流无法显示

**开发模式：** Mock 摄像头会显示灰色背景 + 文字，这是正常的

**生产模式：** 检查摄像头是否正确连接，查看后端日志

### 7.3 登录后 Token 失效

**原因：** Token 过期或 JWT 密钥不一致

**解决：** 检查 `config.py` 中的 `JWT_SECRET_KEY` 和 `JWT_EXPIRE_HOURS`

### 7.4 人脸识别失败

**开发模式：** Mock 引擎返回固定特征，用于测试流程

**生产模式：** 确保 `face_app/lib/libface_engine.so` 已正确编译并加载

---

## 8. 技术要点

### 8.1 前后端通信

- 数据格式： 统一使用 JSON（除文件上传和视频流）
- 认证方式： JWT Bearer Token
- 跨域处理： 同源部署，无需 CORS 配置
- 错误处理： 统一返回 `{"status": "error", "msg": "..."}`

### 8.2 安全考虑

**当前实现（课设级别）：**
- 密码明文存储
- 简单的 JWT 认证
- 无 HTTPS 加密

**生产环境建议：**
- 使用 bcrypt 加密密码
- 配置 HTTPS/SSL
- 添加请求频率限制
- 实现 Token 刷新机制

### 8.3 性能优化

- 视频流： MJPEG 格式，客户端自动处理
- 后台任务： 开门操作使用 FastAPI BackgroundTasks
- 数据库： SQLite + 连接池（check_same_thread=False）
- 并发： Uvicorn + async/await 异步处理

---

## 9. 开发调试技巧

### 9.1 查看日志

后端启动后会输出详细日志：
```bash
[INFO] 开发模式：使用 Mock 模拟硬件
[MockCamera] 开发模式：使用模拟摄像头
[MockFaceEngine] 开发模式：使用模拟人脸引擎
```

### 9.2 测试接口

使用浏览器开发者工具（F12）查看：
- Network 标签：HTTP 请求和响应
- Console 标签：JavaScript 错误
- Application 标签：localStorage 中的 token

### 9.3 调试数据库

```bash
# 查看数据库内容
python -c "import sqlite3; conn = sqlite3.connect('backend/database/database.db'); cursor = conn.cursor(); cursor.execute('SELECT * FROM administrators'); print(cursor.fetchall())"
```

---

## 10. 附录

### 10.1 项目依赖

```
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
jinja2>=3.1.2
opencv-python>=4.8.0
numpy<2.0
PyJWT>=2.8.0
python-multipart>=0.0.6
```

### 10.2 浏览器兼容性

- Chrome 90+
- Firefox 88+
- Edge 90+
- Safari 14+

### 10.3 参考资料

- FastAPI 官方文档：https://fastapi.tiangolo.com/
- Bootstrap 5 文档：https://getbootstrap.com/
- MJPEG 流说明：https://en.wikipedia.org/wiki/Motion_JPEG

---

**文档版本：** 1.0
**更新日期：** 2025-12-19
**维护人员：** Juyao Huang
